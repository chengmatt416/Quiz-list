<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è€ƒå·æ¸…å–®èˆ‡è¨‚æ­£é€²åº¦ï¼ˆå«åˆ°æœŸæ—¥ã€åŒ¯å‡ºæ—¥æ›†ã€ç•ªèŒ„é˜ï¼‰</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="ä¸€å€‹åŠŸèƒ½å®Œæ•´çš„è€ƒå·æ¸…å–®ç®¡ç†ç³»çµ±ï¼Œå…·å‚™åˆ°æœŸæ—¥è¿½è¹¤ã€æ—¥æ›†åŒ¯å‡ºåŠç•ªèŒ„é˜è¨ˆæ™‚åŠŸèƒ½" />
    <meta name="theme-color" content="#3498db" />
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="è€ƒå·æ¸…å–®" />
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="96x96" href="/icon-96x96.png" />
    <link rel="apple-touch-icon" sizes="128x128" href="/icon-128x128.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192x192.png" />
    <link rel="apple-touch-icon" sizes="384x384" href="/icon-384x384.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="/icon-512x512.png" />
    
    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icon-72x72.png" />
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#3498db" />
    <meta name="msapplication-TileImage" content="/icon-144x144.png" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root{
            --bg-color:#f4f7f6;
            --text-color:#333;
            --container-bg:#fff;
            --primary-color:#3498db;
            --secondary-color:#ecf0f1;
            --accent-color:#e74c3c;
            --border-color:#eee;
            --header-color:#2c3e50;
            --shadow-color:rgba(0,0,0,0.08);
            --progress-complete-color:#27ae60;
            --progress-correction-overall-color:#f39c12;
            --progress-correction-done-color:#16a085;
            --muted:#7f8c8d;
        }
        body.dark-mode{
            --bg-color:#1f2a36;
            --text-color:#ecf0f1;
            --container-bg:#263640;
            --primary-color:#5dade2;
            --secondary-color:#20303b;
            --accent-color:#e74c3c;
            --border-color:#394a56;
            --header-color:#ecf0f1;
            --shadow-color:rgba(0,0,0,0.6);
            --muted:#aab7c1;
        }
        *{box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
            background:var(--bg-color);
            color:var(--text-color);
            margin:0;
            padding:20px;
            padding-bottom: 160px;
            display:flex;
            justify-content:center;
            transition:background .25s,color .25s;
        }
        .wrap{
            width:100%;
            max-width:980px;
        }
        .container{
            background:var(--container-bg);
            padding:22px;
            border-radius:12px;
            box-shadow:0 8px 24px var(--shadow-color);
            transition:transform .18s, box-shadow .18s;
        }
        .header{
            display:flex;
            gap:12px;
            align-items:flex-start;
            justify-content:space-between;
        }
        h1{margin:0 0 6px 0; color:var(--header-color);}
        .top-actions{display:flex; gap:8px;}
        button, .icon-btn{
            padding: 6px 10px;
            font-size: 14px;
            border-radius:8px;
            border:none;
            cursor:pointer;
            background:var(--primary-color);
            color:white;
            font-weight:600;
            box-shadow:0 6px 18px rgba(0,0,0,0.06);
            transition:transform .12s, box-shadow .12s, opacity .12s;
        }
        button:active{transform:translateY(1px)}
        .icon-btn{display:inline-flex;align-items:center;gap:8px}
        .theme-toggle{
            background: #7f8c8d;
            color: white;
        }
        .toolbar{
            display:flex;flex-wrap:wrap;gap:10px;margin:16px 0 18px 0;align-items:center;
        }
        #search-box{
            padding:10px;border-radius:8px;border:1px solid var(--border-color);flex:1;min-width:160px;
            background:transparent;color:var(--text-color);
        }
        .sort-controls{display:flex;gap:8px}
        .card{
            padding:16px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
            border:1px solid var(--border-color); margin-top:14px;
        }
        .summary{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center}
        .progress-bar-container{background:#ddd;border-radius:999px;overflow:hidden;height:18px;box-shadow:inset 0 -2px 6px rgba(0,0,0,0.06)}
        .progress-bar{
            height:100%; width:0; text-align:center; line-height:18px; font-weight:700;
            color:white; transition:width .8s cubic-bezier(.2,.9,.2,1), background .4s;
            will-change:width;
        }
        .summary p{margin:6px 0 0 0;color:var(--muted);font-size:14px}
        .exam-group h3{
            background:var(--primary-color);color:white;padding:8px;border-radius:8px;margin:14px 0 8px 0;
            display:inline-block; font-size:16px;
        }
        .exam-list{list-style:none;padding:0;margin:0;display:grid;gap:8px}
        .exam-list.card-view{grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:12px}
        .exam-item{
            display:flex;align-items:center;padding:12px;border-radius:10px;border:1px solid var(--border-color);
            transition:transform .45s cubic-bezier(.2,.9,.2,1), box-shadow .22s, opacity .22s;
            background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
            will-change:transform,opacity;
            overflow:hidden;
            opacity:0; transform: translateY(10px) scale(0.995);
            animation: fadeScaleIn 420ms ease forwards;
        }
        .exam-list.card-view .exam-item{
            flex-direction:column;align-items:stretch;padding:16px;
        }
        .exam-list.card-view .exam-item .left{
            flex-direction:column;align-items:flex-start;gap:10px;
        }
        .exam-list.card-view .exam-item .exam-actions{
            margin-left:0;margin-top:12px;justify-content:flex-start;flex-wrap:wrap;
        }
        .exam-list.card-view .exam-item .correction-control{
            margin-left:0;
        }
        @keyframes fadeScaleIn{
            from{opacity:0; transform:translateY(12px) scale(0.985)}
            to{opacity:1; transform:translateY(0) scale(1)}
        }
        .exam-item .left{display:flex;align-items:center;gap:12px;flex:1}
        .exam-item input[type="checkbox"]{transform:scale(1.35);cursor:pointer}
        .exam-info{display:flex;flex-direction:column;gap:4px}
        .chapter{font-weight:700;font-size:15px;display:inline-block}
        .meta{font-size:13px;color:var(--muted)}
        .question-count{min-width:80px;text-align:right;font-weight:700;color:var(--accent-color)}
        .delete-btn{background:none;border:none;color:var(--accent-color);font-size:20px;cursor:pointer;opacity:.6}
        .delete-btn:hover{opacity:1;transform:scale(1.06)}
        .correction-control{display:flex;align-items:center;gap:6px; font-size:13px;color:var(--muted); margin-left:12px}
        .exam-item.completed .chapter{ text-decoration:line-through; opacity:0.6 }
        .due-date{font-size:13px;padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.03); color:var(--muted); margin-left:8px}
        .due-date.overdue{background:linear-gradient(90deg,#f9e0e0,#fde6e6); color:var(--accent-color); font-weight:700}
        .exam-actions{display:flex;gap:8px;align-items:center;margin-left:12px}
        
        .exam-actions .icon-btn {
            padding: 4px 8px;
            font-size: 12px;
            color: white; 
        }

        .exam-item:hover{transform:translateY(-4px) scale(1.005); box-shadow:0 10px 30px rgba(0,0,0,0.06)}
        .progress-bar.animate {
            transition: width 900ms cubic-bezier(.18,.9,.32,1), background 400ms;
        }
        .add-exam-form{margin-top:18px;padding:12px;border-radius:10px;border:1px dashed var(--border-color);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        .add-exam-form input, .add-exam-form button, .add-exam-form select{padding:8px;border-radius:8px;border:1px solid var(--border-color);background:transparent;color:var(--text-color)}
        .add-exam-form input { flex: 1 1 120px; }
        .add-exam-form input[type="number"]{ flex: 1 1 80px; }
        .add-exam-form button { flex: 1 1 80px; }
        .add-exam-form .submit{background:#27ae60;color:white;border:none}
        
        .small{font-size:13px;color:var(--muted)}
        .muted{color:var(--muted)}

        .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border-color);font-size:13px}

        /* pomodoro */
        .pomodoro-panel{
            position:fixed; right:18px; bottom:18px; width:320px; max-width:90vw; z-index:999;
            background:var(--container-bg); border-radius:14px; padding:14px; box-shadow:0 16px 48px rgba(0,0,0,0.18);
            border:1px solid var(--border-color);
            transition: opacity .4s, transform .4s cubic-bezier(.2,.9,.2,1);
        }
        .pomodoro-panel:not(.hidden) {
            animation: popIn 420ms cubic-bezier(.2,.9,.2,1) forwards;
        }
        .pomodoro-panel.hidden {
            opacity: 0;
            transform: translateY(24px) scale(.98);
            pointer-events: none;
            visibility: hidden;
        }
        @keyframes popIn{
            from{opacity:0; transform: translateY(24px) scale(.98)}
            to{opacity:1; transform: translateY(0) scale(1)}
        }
        .pomodoro-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
        .timer-display{font-size:36px;font-weight:800;text-align:center;margin:8px 0; transition:transform .15s}
        .pom-controls{display:flex;gap:8px;justify-content:center}
        .cycle-indicator{display:flex;gap:6px;justify-content:center;margin-top:8px}
        .cycle-dot{width:10px;height:10px;border-radius:50%;background:#ddd}
        .cycle-dot.active{background:var(--primary-color); box-shadow:0 6px 14px rgba(0,0,0,0.08)}
        .pom-close-btn {
            background: none; border: none; font-size: 22px;
            color: var(--muted); cursor: pointer; padding: 0 4px; line-height: 1;
        }
        .pom-close-btn:hover { color: var(--text-color); }

        .pom-fullscreen {
            position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center;
            background: rgba(0,0,0,0.7); transition:opacity .18s;
        }
        .pom-fullscreen .pom-inner {
            width: min(920px, 96vw); background: var(--container-bg); padding: 28px; border-radius:12px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.6); text-align:center;
        }
        .pom-fullscreen .timer-display { font-size:96px; }
        .pom-fullscreen .pom-controls button { font-size:20px; padding:10px 18px; border-radius:12px; }

        /* Modal styles */
        .modal{
            position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9998;
            display:flex; align-items:center; justify-content:center; animation: fadeIn 0.3s;
        }
        .modal-content{
            background:var(--container-bg); padding:28px; border-radius:12px; max-width:500px; width:90%;
            box-shadow:0 24px 64px rgba(0,0,0,0.3); animation: slideUp 0.4s cubic-bezier(.2,.9,.2,1);
        }
        .modal-content h2{margin:0 0 12px 0; color:var(--header-color)}
        .form-group{margin:16px 0}
        .form-group label{display:block; margin-bottom:8px; font-weight:600; color:var(--text-color)}
        .form-group input, .form-group select{
            width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color);
            background:transparent; color:var(--text-color); font-size:14px;
        }
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}

        /* Schedule styles */
        .schedule-day{
            border:1px solid var(--border-color); border-radius:10px; padding:16px; margin-bottom:12px;
            background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
        }
        .schedule-day-header{
            display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;
            padding-bottom:8px; border-bottom:1px solid var(--border-color);
        }
        .schedule-day-title{font-size:16px; font-weight:700; color:var(--header-color)}
        .schedule-day-stats{font-size:13px; color:var(--muted)}
        .schedule-items{
            min-height:50px;
        }
        .schedule-item{
            display:flex; align-items:center; gap:12px; padding:8px; border-radius:8px;
            background:rgba(0,0,0,0.02); margin:6px 0; transition:transform .2s;
            cursor:move;
        }
        .schedule-item:hover{transform:translateX(4px)}
        .schedule-item-subject{font-weight:600; min-width:80px}
        .schedule-item-chapter{flex:1; color:var(--muted)}
        .schedule-item-questions{
            padding:4px 10px; border-radius:999px; background:var(--primary-color);
            color:white; font-size:12px; font-weight:600;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: var(--secondary-color);
        }
        .sortable-chosen {
            background: var(--primary-color);
            color: white;
        }
        .sortable-drag {
            opacity: 0.8;
        }

        @media (max-width:720px){
            body { 
                padding: 10px; 
                padding-bottom: 160px;
            }
            .container { padding: 15px; }
            .summary{grid-template-columns:1fr}
            .top-actions{flex-wrap:wrap}
            .toolbar { flex-direction: column; align-items: stretch; }
            .pomodoro-panel{right:8px;left:8px;bottom:12px;width:auto}
            .modal-content{width:95%; padding:20px}
        }
        
        /* PWA Mode adjustments */
        body.pwa-mode {
            /* Add extra padding for iOS safe areas */
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 160px);
        }
        
        @supports (padding: max(0px)) {
            body.pwa-mode {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
            }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="container">
            <div class="header">
                <div>
                    <h1>è€ƒå·æ¸…å–®</h1>
                    <div class="small muted">åˆ°æœŸæ—¥ã€åŒ¯å‡ºæ—¥æ›† (.ics)ã€ç•ªèŒ„é˜ â€” å·²ä¿ç•™ä½ çš„é è¨­æ¸…å–®</div>
                </div>
                <div class="top-actions">
                    <button id="show-scheduler" class="icon-btn">æ™ºæ…§æ’ç¨‹ ğŸ¤–</button>
                    <button id="show-pomodoro" class="icon-btn">é¡¯ç¤ºç•ªèŒ„é˜</button>
                    <button id="pom-fullscreen-toggle" class="icon-btn">ç•ªèŒ„é˜å…¨è¢å¹•</button>
                    <button id="srs-auto-plan" class="icon-btn">SRS è‡ªå‹•è¦åŠƒ</button>
                    <button id="experimental-plan" class="icon-btn" style="background:#9b59b6;color:white">ğŸ§ª å¯¦é©—æ€§è¦åŠƒ</button>
                    <button id="export-srs-report" class="icon-btn">åŒ¯å‡º SRS å ±å‘Š</button>
                    <button id="export-all-ics" class="icon-btn">åŒ¯å‡ºå…¨éƒ¨åˆ°æ—¥æ›†</button>
                    <button id="export-json" class="icon-btn">åŒ¯å‡º JSON</button>
                    <button id="export-pdf" class="icon-btn">åŒ¯å‡º PDF</button>
                    <label for="import-json-file" class="icon-btn" style="cursor:pointer;padding:6px 10px">åŒ¯å…¥ JSON</label>
                    <input type="file" id="import-json-file" accept="application/json" style="display:none" />
                    <button id="clear-storage" class="theme-toggle">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
                    <button id="theme-toggle" class="theme-toggle">åˆ‡æ›æ·±è‰²</button>
                </div>
            </div>

            <div class="toolbar">
                <input id="search-box" placeholder="æœå°‹ç§‘ç›®æˆ–ç« ç¯€..." />
                <div class="sort-controls">
                    <button id="sort-by-questions">æŒ‰é¡Œæ•¸æ’åº</button>
                    <button id="sort-by-chapter">æŒ‰ç« ç¯€æ’åº</button>
                    <button id="sort-by-due">ä¾åˆ°æœŸæ—¥æ’åº</button>
                    <button id="toggle-card-view" class="theme-toggle">åˆ‡æ›å¡ç‰‡æª¢è¦–</button>
                </div>
                <div style="display:flex;gap:6px;align-items:center;margin-left:12px">
                    <select id="filter-select" class="small" title="ç¯©é¸">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="today">ç•¶æ—¥åˆ°æœŸ</option>
                        <option value="overdue">å·²éæœŸ</option>
                        <option value="7days">ä¸ƒå¤©å…§</option>
                        <option value="noduedate">ç„¡æ¨™ç¤ºåˆ°æœŸæ—¥</option>
                    </select>
                    <div class="pill small">ç¸½é¡Œæ•¸ï¼š<span id="total-questions">0</span></div>
                </div>
            </div>

            <div class="card summary">
                <div>
                    <h4>å®Œæˆé€²åº¦</h4>
                    <div class="progress-bar-container" style="margin-top:8px">
                        <div id="progress-bar" class="progress-bar" style="background:var(--progress-complete-color)">0%</div>
                    </div>
                    <p>å°šæœªå®Œæˆç¸½é¡Œæ•¸: <strong id="remaining-questions">0</strong> | å·²å®Œæˆç¸½é¡Œæ•¸: <strong id="completed-questions">0</strong></p>
                </div>
                <div>
                    <h4>è¨‚æ­£é€²åº¦</h4>
                    <div style="margin-top:8px">
                        <div class="small muted">æ•´é«”ï¼ˆå«æœªå®Œæˆï¼‰</div>
                        <div class="progress-bar-container" style="margin-top:6px">
                            <div id="correction-progress-bar" class="progress-bar" style="background:var(--progress-correction-overall-color)">0%</div>
                        </div>
                        <div class="small muted" style="margin-top:8px">å·²å®Œæˆè€ƒå·ä¹‹è¨‚æ­£é€²åº¦</div>
                        <div class="progress-bar-container" style="margin-top:6px">
                            <div id="completed-correction-progress-bar" class="progress-bar" style="background:var(--progress-correction-done-color)">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="exam-list-container"></div>

            <div class="add-exam-form">
                <input type="text" id="new-subject" placeholder="ç§‘ç›®" required />
                <input type="text" id="new-chapter" placeholder="ç« ç¯€" required />
                <input type="number" id="new-questions" placeholder="é¡Œæ•¸" required min="1" />
                <input type="date" id="new-due" />
                <button id="clear-due-btn" class="icon-btn small" style="background:#95a5a6">æ¸…é™¤æ—¥æœŸ</button>
                <button id="add-btn" class="submit">æ–°å¢</button>
                <div style="margin-left:auto" class="small muted">åˆ°æœŸæ—¥(é¸å¡«)ï¼ŒåŒ¯å‡ºæ—¥æ›†æ™‚æœƒä½¿ç”¨</div>
            </div>
        </div>

        <!-- Smart Scheduler Panel -->
        <div id="scheduler-panel" class="container" style="margin-top:20px;display:none">
            <h2>æ™ºæ…§æ’ç¨‹ç³»çµ± ğŸ¤–</h2>
            <div class="small muted" style="margin-bottom:16px">æ ¹æ“šä½ çš„å­¸ç¿’èƒ½åŠ›è‡ªå‹•è¦åŠƒæ¯æ—¥è€ƒå·é€²åº¦</div>
            
            <div id="schedule-view">
                <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
                    <button id="regenerate-schedule" class="icon-btn">é‡æ–°ç”Ÿæˆæ’ç¨‹</button>
                    <button id="schedule-settings" class="icon-btn theme-toggle">æ’ç¨‹è¨­å®š</button>
                    <button id="hide-schedule" class="icon-btn theme-toggle">éš±è—æ’ç¨‹</button>
                </div>
                <div id="schedule-container"></div>
            </div>
        </div>

        <!-- Onboarding Modal -->
        <div id="onboarding-modal" class="modal" style="display:none">
            <div class="modal-content">
                <h2>æ­¡è¿ä½¿ç”¨æ™ºæ…§æ’ç¨‹ç³»çµ±ï¼ğŸ‘‹</h2>
                <p class="small muted">è®“æˆ‘å€‘äº†è§£ä½ çš„å­¸ç¿’ç¿’æ…£ï¼Œç‚ºä½ è‡ªå‹•è¦åŠƒè€ƒå·é€²åº¦</p>
                
                <div class="form-group">
                    <label for="daily-capacity">æ¯æ—¥å¯å®Œæˆé¡Œæ•¸ï¼š</label>
                    <input type="number" id="daily-capacity" min="10" max="500" value="50" />
                    <div class="small muted">å»ºè­°æ ¹æ“šä½ çš„æ™‚é–“å’Œå°ˆæ³¨åŠ›è¨­å®šï¼ˆä¾‹å¦‚ï¼š50-100é¡Œï¼‰</div>
                </div>
                
                <div class="form-group">
                    <label for="priority-mode">å„ªå…ˆç´šæ¨¡å¼ï¼š</label>
                    <select id="priority-mode">
                        <option value="due-date">ä¾åˆ°æœŸæ—¥å„ªå…ˆ</option>
                        <option value="balanced">å¹³è¡¡åˆ†é…</option>
                        <option value="subject-rotation">ç§‘ç›®è¼ªæ›¿</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="buffer-days">æå‰å®Œæˆç·©è¡å¤©æ•¸ï¼š</label>
                    <input type="number" id="buffer-days" min="0" max="14" value="2" />
                    <div class="small muted">åœ¨åˆ°æœŸæ—¥å‰å¹¾å¤©å®Œæˆï¼ˆé ç•™è¨‚æ­£æ™‚é–“ï¼‰</div>
                </div>
                
                <div style="display:flex;gap:12px;margin-top:20px">
                    <button id="save-settings" class="icon-btn">é–‹å§‹ä½¿ç”¨</button>
                    <button id="skip-onboarding" class="theme-toggle">ç¨å¾Œè¨­å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- fullscreen container (created/hidden dynamically) -->
    <div id="pom-fullscreen" style="display:none"></div>

    <div class="pomodoro-panel" id="pomodoro-panel" aria-live="polite">
        <div class="pomodoro-header">
            <div style="display:flex;gap:8px;align-items:center">
                <strong>ç•ªèŒ„é˜</strong>
                <span id="pom-selected" class="small muted">ï¼ˆå°šæœªé¸æ“‡è€ƒå·ï¼‰</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
                <select id="pom-mode" class="small">
                    <option value="pom">å·¥ä½œï¼ˆç•ªèŒ„ï¼‰</option>
                    <option value="short">çŸ­ä¼‘</option>
                    <option value="long">é•·ä¼‘</option>
                </select>
                <button id="pom-close" class="pom-close-btn" title="éš±è—">&times;</button>
                <button id="pom-start">é–‹å§‹</button>
            </div>
        </div>
        <div class="timer-display" id="timer-display">25:00</div>
        <div class="pom-controls">
            <button id="pom-pause" class="theme-toggle">æš«åœ</button>
            <button id="pom-reset" class="theme-toggle">é‡è¨­</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:center">
            <div class="small muted">é€±æœŸ</div>
            <div id="pom-cycle" class="cycle-indicator"></div>
        </div>
        <div style="margin-top:10px;display:flex;justify-content:center;gap:8px;align-items:center">
            <label class="small muted" style="display:flex;align-items:center;gap:6px">
                <input type="checkbox" id="pom-enable-sound" /> å•Ÿç”¨éŸ³æ•ˆ
            </label>
        </div>
    </div>

    <script>
    // Global helper functions for SRS planning modals (need to be global for onclick handlers)
    window.updatePlanChange = function(index, newDate) {
        if (window.currentSRSPlan && window.currentSRSPlan[index]) {
            window.currentSRSPlan[index].newDate = newDate;
        }
    };
    
    window.closeSRSPlanModal = function() {
        const modal = document.getElementById('srs-plan-modal');
        if (modal) {
            modal.remove();
        }
        window.currentSRSPlan = null;
    };
    
    window.applyAndCloseSRSPlan = function() {
        if (window.currentSRSPlan && window.currentSRSPlan.length > 0) {
            // Call the local applySRSPlan function through a stored reference
            if (window._applySRSPlan) {
                window._applySRSPlan(window.currentSRSPlan);
                alert(`âœ… å·²æˆåŠŸå¥—ç”¨ ${window.currentSRSPlan.length} é …è¦åŠƒï¼`);
            }
        }
        window.closeSRSPlanModal();
    };
    
    window.updateExpPlanChange = function(index, newDate) {
        if (window.currentExpPlan && window.currentExpPlan[index]) {
            window.currentExpPlan[index].newDate = newDate;
        }
    };
    
    window.closeExpPlanModal = function() {
        const modal = document.getElementById('exp-plan-modal');
        if (modal) modal.remove();
        window.currentExpPlan = null;
    };
    
    window.applyAndCloseExpPlan = function() {
        if (window.currentExpPlan && window.currentExpPlan.length > 0) {
            // Call the local functions through stored references
            if (window._exams && window._saveExams && window._render) {
                window.currentExpPlan.forEach(change => {
                    const exam = window._exams.find(e => e.id === change.id);
                    if (exam) {
                        exam.dueDate = change.newDate;
                    }
                });
                window._saveExams();
                window._render();
                alert(`âœ… å·²æˆåŠŸå¥—ç”¨ ${window.currentExpPlan.length} é …è¦åŠƒï¼`);
            }
        }
        window.closeExpPlanModal();
    };
    
    window.closeExpMenu = function() {
        const modal = document.getElementById('exp-menu-modal');
        if (modal) modal.remove();
    };
    
    document.addEventListener('DOMContentLoaded', () => {

        // Initial data (can be customized)
        const initialData = [
            { id: 1, subject: 'æ•¸å­¸', chapter: 'ç¬¬ä¸€ç« ', questions: 50, completed: false, corrected: false, dueDate: null },
            { id: 2, subject: 'è‹±æ–‡', chapter: 'ç¬¬äºŒç« ', questions: 40, completed: false, corrected: false, dueDate: null },
            { id: 3, subject: 'åœ‹æ–‡', chapter: 'ç¬¬ä¸‰ç« ', questions: 45, completed: false, corrected: false, dueDate: null }
        ];

        let exams = [];
        let sortState = { key: 'chapter', direction: 'asc' };
        let cardViewMode = false;


        const G = {
            container: document.getElementById('exam-list-container'),
            remainingEl: document.getElementById('remaining-questions'),
            completedEl: document.getElementById('completed-questions'),
            progressBar: document.getElementById('progress-bar'),
            correctionProgressBar: document.getElementById('correction-progress-bar'),
            completedCorrectionProgressBar: document.getElementById('completed-correction-progress-bar'),
            searchBox: document.getElementById('search-box'),
            addBtn: document.getElementById('add-btn'),
            newSubject: document.getElementById('new-subject'),
            newChapter: document.getElementById('new-chapter'),
            newQuestions: document.getElementById('new-questions'),
            newDue: document.getElementById('new-due'),
            sortByQuestionsBtn: document.getElementById('sort-by-questions'),
            sortByChapterBtn: document.getElementById('sort-by-chapter'),
            sortByDueBtn: document.getElementById('sort-by-due'),
            toggleCardViewBtn: document.getElementById('toggle-card-view'),
            exportAllIcs: document.getElementById('export-all-ics'),
            exportJsonBtn: document.getElementById('export-json'),
            exportPdfBtn: document.getElementById('export-pdf'),
            importJsonFile: document.getElementById('import-json-file'),
            totalQuestionsEl: document.getElementById('total-questions'),
            themeToggle: document.getElementById('theme-toggle'),
            clearStorageBtn: document.getElementById('clear-storage'),
            clearDueBtn: document.getElementById('clear-due-btn'),
            showPomodoroBtn: document.getElementById('show-pomodoro'),
            pomFullscreenToggle: document.getElementById('pom-fullscreen-toggle'),
            filterSelect: document.getElementById('filter-select'),
            pom: {
                panel: document.getElementById('pomodoro-panel'),
                display: document.getElementById('timer-display'),
                start: document.getElementById('pom-start'),
                pause: document.getElementById('pom-pause'),
                reset: document.getElementById('pom-reset'),
                mode: document.getElementById('pom-mode'),
                selected: document.getElementById('pom-selected'),
                cycle: document.getElementById('pom-cycle'),
                close: document.getElementById('pom-close'),
                enableSound: document.getElementById('pom-enable-sound')
            }
        };

        function saveExams(){ localStorage.setItem('examsList', JSON.stringify(exams)); }
        function loadExams(){
            const s = localStorage.getItem('examsList');
            if(s){
                exams = JSON.parse(s).map(e => ({ 
                    corrected:false, 
                    dueDate:null, 
                    srsLevel:0, 
                    srsLastReview:null, 
                    srsNextReview:null,
                    srsPerformance: [],
                    ...e 
                }));
            } else {
                exams = initialData.slice();
            }
        }

        function render(){
            G.container.innerHTML = '';
            const q = G.searchBox.value.trim().toLowerCase();
            const filter = G.filterSelect.value;
            const filtered = exams.filter(exam => {
                const matchesText = exam.subject.toLowerCase().includes(q) || exam.chapter.toLowerCase().includes(q);
                if(!matchesText) return false;

                // filter logic
                const now = new Date();
                const nowMid = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                if(filter === 'all') return true;
                if(filter === 'noduedate') return !exam.dueDate;
                if(!exam.dueDate) return false;
                const due = new Date(exam.dueDate);
                const dueMid = new Date(due.getFullYear(), due.getMonth(), due.getDate());
                const diffDays = Math.round((dueMid - nowMid) / (24*3600*1000));
                if(filter === 'today') return diffDays === 0;
                if(filter === 'overdue') return diffDays < 0;
                if(filter === '7days') return diffDays >= 0 && diffDays <= 7;
                return true;
            });

            const grouped = filtered.reduce((acc, exam) => {
                (acc[exam.subject] = acc[exam.subject] || []).push(exam);
                return acc;
            }, {});
            const subjectKeys = Object.keys(grouped).sort();
            subjectKeys.forEach(subject => {
                const list = grouped[subject];
                list.sort((a,b) => {
                    let va = a[sortState.key], vb = b[sortState.key];
                    if(sortState.key === 'dueDate'){
                        if(!va && !vb) return 0;
                        if(!va) return sortState.direction === 'asc' ? 1 : -1;
                        if(!vb) return sortState.direction === 'asc' ? -1 : 1;
                        va = new Date(va).getTime();
                        vb = new Date(vb).getTime();
                    }
                    if(typeof va === 'string') va = va.toLowerCase();
                    if(typeof vb === 'string') vb = vb.toLowerCase();
                    if(va > vb) return sortState.direction === 'asc' ? 1 : -1;
                    if(va < vb) return sortState.direction === 'asc' ? -1 : 1;
                    return 0;
                });
            });

            subjectKeys.forEach(subject => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'exam-group';
                groupDiv.innerHTML = `<h3>${subject}</h3>`;
                const ul = document.createElement('ul');
                ul.className = 'exam-list';
                if(cardViewMode) ul.classList.add('card-view');
                grouped[subject].forEach(exam => {
                    const li = document.createElement('li');
                    li.className = 'exam-item';
                    if(exam.completed) li.classList.add('completed');
                    let dueHtml = '';
                    if(exam.dueDate){
                        const now = new Date();
                        const due = new Date(exam.dueDate);
                        const nowMid = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const dueMid = new Date(due.getFullYear(), due.getMonth(), due.getDate());
                        const diffDays = Math.round((dueMid - nowMid) / (24*3600*1000));
                        const overdue = diffDays < 0;
                        const label = overdue ? `å·²éæœŸ ${Math.abs(diffDays)} å¤©` : (diffDays === 0 ? 'åˆ°æœŸï¼šä»Šå¤©' : `åˆ°æœŸï¼š${diffDays} å¤©å¾Œ`);
                        dueHtml = `<span class="due-date ${overdue ? 'overdue': ''}" title="${formatDate(due)}">${label}</span>`;
                    }
                    
                    // SRS level display
                    let srsHtml = '';
                    if(exam.srsLevel && exam.srsLevel > 0){
                        srsHtml = `<span class="pill small" style="margin-left:8px;background:#e8f5e9;color:#2e7d32">SRS ${exam.srsLevel}</span>`;
                    }
                    
                    // SRS buttons - show for all tasks
                    let srsButtons = `
                        <button class="icon-btn srs-advance-btn small" data-id="${exam.id}" style="background:#27ae60" title="è¤‡ç¿’æˆåŠŸï¼Œæå‡ç­‰ç´š">SRS+</button>
                        <button class="icon-btn srs-decrease-btn small" data-id="${exam.id}" style="background:#e67e22" title="è¤‡ç¿’å›°é›£ï¼Œé™ä½ç­‰ç´š">SRS-</button>
                    `;
                    
                    li.innerHTML = `
                        <div class="left">
                            <input type="checkbox" class="completion-checkbox" data-id="${exam.id}" ${exam.completed ? 'checked' : ''} />
                            <div class="exam-info">
                                <div>
                                    <span class="chapter">${escapeHtml(exam.chapter)}</span>
                                    ${dueHtml}
                                    ${srsHtml}
                                </div>
                                <div class="meta small muted">${escapeHtml(exam.subject)} ãƒ» <span class="meta-questions">${exam.questions} é¡Œ</span></div>
                            </div>
                        </div>
                        <div class="exam-actions">
                            <label class="correction-control"><input type="checkbox" class="correction-checkbox" data-id="${exam.id}" ${exam.corrected ? 'checked' : ''} /> è¨‚æ­£</label>
                            ${srsButtons}
                            <button class="icon-btn edit-btn small" data-id="${exam.id}">ç·¨è¼¯</button>
                            <button class="icon-btn ics-btn small" data-id="${exam.id}">åŒ¯å‡ºæ—¥æ›†</button>
                            <button class="delete-btn" data-id="${exam.id}" title="åˆªé™¤">&times;</button>
                        </div>
                    `;
                    ul.appendChild(li);
                });
                groupDiv.appendChild(ul);
                G.container.appendChild(groupDiv);
            });
            updateSummary();
            attachRowListeners();
        }

        function attachRowListeners(){
            document.querySelectorAll('.completion-checkbox').forEach(cb => cb.addEventListener('change', e => toggleExam(Number(cb.dataset.id))));
            document.querySelectorAll('.correction-checkbox').forEach(cb => cb.addEventListener('change', e => toggleCorrection(Number(cb.dataset.id))));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => deleteExam(Number(btn.dataset.id))));
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => openEditDialog(Number(btn.dataset.id))));
            document.querySelectorAll('.ics-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const exam = exams.find(x => x.id === Number(btn.dataset.id));
                    if(exam) downloadICS(exam);
                });
            });
            document.querySelectorAll('.srs-advance-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    advanceSRSLevel(Number(btn.dataset.id));
                });
            });
            document.querySelectorAll('.srs-decrease-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    decreaseSRSLevel(Number(btn.dataset.id));
                });
            });
            document.querySelectorAll('.chapter').forEach(el => {
                el.style.cursor = 'pointer';
                el.addEventListener('click', e => {
                    const li = el.closest('.exam-item');
                    selectPomodoroExam(findIdFromElement(li));
                });
            });
        }

        function findIdFromElement(el){
            const checkbox = el.querySelector('.completion-checkbox');
            return checkbox ? Number(checkbox.dataset.id) : null;
        }

        function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
        function formatDate(d){
            if(!d) return '';
            const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${day}`;
        }

        function updateSummary(){
            let remainingTotal = 0, completedTotal = 0, totalQuestions = 0, correctedTotal = 0;
            exams.forEach(exam => {
                totalQuestions += Number(exam.questions || 0);
                if(exam.completed){
                    completedTotal += Number(exam.questions || 0);
                    if(exam.corrected) correctedTotal += Number(exam.questions || 0);
                } else {
                    remainingTotal += Number(exam.questions || 0);
                }
            });
            G.remainingEl.textContent = remainingTotal;
            G.completedEl.textContent = completedTotal;
            G.totalQuestionsEl.textContent = totalQuestions;
            animateBar(G.progressBar, totalQuestions > 0 ? Math.round((completedTotal/totalQuestions)*100) : 0);
            animateBar(G.correctionProgressBar, totalQuestions > 0 ? Math.round((correctedTotal/totalQuestions)*100) : 0);
            animateBar(G.completedCorrectionProgressBar, completedTotal > 0 ? Math.round((correctedTotal/completedTotal)*100) : 0);
        }

        function animateBar(el, pct){
            el.classList.add('animate');
            el.style.width = pct + '%';
            el.textContent = pct + '%';
            setTimeout(()=> el.classList.remove('animate'), 900);
        }

        function toggleExam(id){
            const ex = exams.find(e => e.id === id);
            if(!ex) return;
            ex.completed = !ex.completed;
            if(!ex.completed) ex.corrected = false;
            saveExams(); render();
        }
        function toggleCorrection(id){
            const ex = exams.find(e => e.id === id);
            if(!ex || !ex.completed) return;
            ex.corrected = !ex.corrected;
            saveExams(); render();
        }
        function deleteExam(id){
            const el = document.querySelector(`[data-id="${id}"]`)?.closest('.exam-item');
            exams = exams.filter(e => e.id !== id);
            saveExams();
            if(el){
                el.style.opacity = '0'; el.style.transform = 'scale(.98) translateX(-8px)';
                setTimeout(render, 220);
            } else render();
        }

        function addExam(e){
            e && e.preventDefault && e.preventDefault();
            const subject = G.newSubject.value.trim();
            const chapter = G.newChapter.value.trim();
            const questions = Number(G.newQuestions.value || 0);
            const dueVal = G.newDue.value || null;
            if(!subject || !chapter || questions <= 0) return alert('è«‹å¡«ç§‘ç›®ã€ç« ç¯€èˆ‡é¡Œæ•¸ï¼ˆé¡Œæ•¸éœ€å¤§æ–¼ 0ï¼‰');
            exams.push({
                id: Date.now()+Math.floor(Math.random()*999),
                subject, chapter, questions, completed:false, corrected:false, dueDate: dueVal ? dueVal : null,
                srsLevel: 0, srsLastReview: null, srsNextReview: null, srsPerformance: []
            });
            saveExams();
            render();
            G.newSubject.value=''; G.newChapter.value=''; G.newQuestions.value=''; G.newDue.value='';
        }

        function openEditDialog(id){
            const ex = exams.find(x => x.id === id);
            if(!ex) return;
            const subject = prompt('ç·¨è¼¯ç§‘ç›®ï¼š', ex.subject); if(subject === null) return;
            const chapter = prompt('ç·¨è¼¯ç« ç¯€ï¼š', ex.chapter); if(chapter === null) return;
            const questions = prompt('ç·¨è¼¯é¡Œæ•¸ï¼š', ex.questions); if(questions === null) return;
            const due = prompt('åˆ°æœŸæ—¥ (YYYY-MM-DD, ç©ºç™½è¡¨ç¤ºæ¸…é™¤)ï¼š', ex.dueDate || '');
            const qn = Number(questions);
            if(isNaN(qn) || qn <= 0){ alert('é¡Œæ•¸ä¸åˆæ³•'); return; }
            ex.subject = subject.trim() || ex.subject;
            ex.chapter = chapter.trim() || ex.chapter;
            ex.questions = qn;
            ex.dueDate = due ? due.trim() : null;
            saveExams(); render();
        }

        function pad(n){ return String(n).padStart(2,'0'); }
        
        function downloadFile(filename, content, mime='text/calendar;charset=utf-8'){
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            a.remove(); URL.revokeObjectURL(url);
        }

        // ICS creation: improved for compatibility (DTSTAMP, UID, METHOD:PUBLISH)
        function toUTCStamp(date){
            const y = date.getUTCFullYear(), m = pad(date.getUTCMonth()+1), d = pad(date.getUTCDate()),
                hh = pad(date.getUTCHours()), mm = pad(date.getUTCMinutes()), ss = pad(date.getUTCSeconds());
            return `${y}${m}${d}T${hh}${mm}${ss}Z`;
        }

        function escapeICSText(s){ return (s||'').replace(/\\/g, '\\\\').replace(/,/g,'\\,').replace(/;/g, '\\;').replace(/\n/g, '\\n'); }

        function createICSForExam(exam) {
            const e = {...exam};
            if (!e.dueDate) {
                // If no due date, default to today's date (local)
                const today = new Date();
                e.dueDate = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;
            }

            // DTSTART and DTEND as all-day dates (VALUE=DATE). Ensure DTEND is next day.
            const dateParts = e.dueDate.split('-').map(part => parseInt(part, 10));
            const startDateObj = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2]));
            const endDateObj = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2]));
            endDateObj.setUTCDate(endDateObj.getUTCDate() + 1);

            const dtStart = `${startDateObj.getUTCFullYear()}${pad(startDateObj.getUTCMonth()+1)}${pad(startDateObj.getUTCDate())}`;
            const dtEnd = `${endDateObj.getUTCFullYear()}${pad(endDateObj.getUTCMonth()+1)}${pad(endDateObj.getUTCDate())}`;

            const summary = `åˆ°æœŸï¼š${e.subject} ${e.chapter} (${e.questions} é¡Œ)`;
            const description = `è€ƒå·åˆ°æœŸï¼š${e.subject} ${e.chapter}\\né¡Œæ•¸ï¼š${e.questions}\\nä¾†æºï¼šè€ƒå·æ¸…å–®`;

            const uid = `exam-${e.id}-${Date.now()}@examlist.local`;
            const dtstamp = toUTCStamp(new Date());

            const icsEvent = [
                'BEGIN:VEVENT',
                `UID:${uid}`,
                `DTSTAMP:${dtstamp}`,
                `SUMMARY:${escapeICSText(summary)}`,
                `DESCRIPTION:${escapeICSText(description)}`,
                `DTSTART;VALUE=DATE:${dtStart}`,
                `DTEND;VALUE=DATE:${dtEnd}`,
                `CATEGORIES:${escapeICSText(e.subject)}`,
                'TRANSP:TRANSPARENT',
                'SEQUENCE:0',
                'END:VEVENT'
            ].join('\r\n');

            return icsEvent;
        }

        function downloadICS(exam){
            const icsEvent = createICSForExam(exam);
            const icsCalendar = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//ExamList//SingleExport//TW',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                icsEvent,
                'END:VCALENDAR'
            ].join('\r\n');
            downloadFile(`${(exam.subject+'-'+(exam.chapter || 'exam')).replace(/\s+/g,'_')}.ics`, icsCalendar);
        }

        function downloadAllICS(){
            const events = exams.map(ex => createICSForExam(ex)).join('\r\n');
            const ics = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//ExamList//CalendarExportAll//TW',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:è€ƒå·æ¸…å–®',
                events,
                'END:VCALENDAR'
            ].join('\r\n');
            downloadFile('exams_all.ics', ics);
        }

        // JSON export/import
        function exportJSON(){
            const data = JSON.stringify(exams, null, 2);
            downloadFile('exams.json', data, 'application/json;charset=utf-8');
        }

        // PDF export with Traditional Chinese support
        async function exportPDF(){
            // Check if jsPDF is available
            if (!window.jspdf && !window.jsPDF) {
                alert('PDF åŒ¯å‡ºåŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }
            const { jsPDF } = window.jspdf || window;
            
            // Create a temporary container for rendering
            const container = document.createElement('div');
            container.style.cssText = 'position:absolute;left:-9999px;top:0;width:800px;background:white;padding:30px;font-family:Arial,sans-serif;';
            document.body.appendChild(container);
            
            // Summary statistics
            let remainingTotal = 0, completedTotal = 0, totalQuestions = 0, correctedTotal = 0;
            exams.forEach(exam => {
                totalQuestions += Number(exam.questions || 0);
                if(exam.completed){
                    completedTotal += Number(exam.questions || 0);
                    if(exam.corrected) correctedTotal += Number(exam.questions || 0);
                } else {
                    remainingTotal += Number(exam.questions || 0);
                }
            });
            
            // Build HTML content with Chinese characters
            let html = `
                <div style="text-align:center;font-size:24px;font-weight:bold;margin-bottom:20px;color:#2c3e50;">
                    è€ƒå·æ¸…å–®
                </div>
                <div style="font-size:14px;margin-bottom:25px;line-height:1.8;color:#333;">
                    <div>ç¸½é¡Œæ•¸: ${totalQuestions}</div>
                    <div>å°šæœªå®Œæˆ: ${remainingTotal} | å·²å®Œæˆ: ${completedTotal}</div>
                    <div>å·²è¨‚æ­£: ${correctedTotal}</div>
                </div>
            `;
            
            // Add exam cards
            exams.forEach((exam, idx) => {
                const bgColor = exam.completed ? '#e6fae6' : '#fafafa';
                const status = exam.completed ? (exam.corrected ? "å·²å®Œæˆ+å·²è¨‚æ­£" : "å·²å®Œæˆ") : "æœªå®Œæˆ";
                const dueText = exam.dueDate ? exam.dueDate : "æœªè¨­å®š";
                
                html += `
                    <div style="border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:12px;background:${bgColor};">
                        <div style="font-size:16px;font-weight:bold;margin-bottom:8px;color:#2c3e50;">${exam.subject}</div>
                        <div style="font-size:12px;line-height:1.6;color:#555;">
                            <div>ç« ç¯€: ${exam.chapter}</div>
                            <div>é¡Œæ•¸: ${exam.questions}</div>
                            <div style="font-weight:bold;">ç‹€æ…‹: ${status}</div>
                            <div>åˆ°æœŸæ—¥: ${dueText}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Render to canvas with html2canvas (supports Chinese fonts)
            try {
                const canvas = await html2canvas(container, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false
                });
                
                // Create PDF and add the rendered image
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // If content is too tall, split into multiple pages
                const pageHeight = 295; // A4 height in mm
                let heightLeft = imgHeight;
                let position = 0;
                
                doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                doc.save('exams.pdf');
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('PDF åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                // Clean up
                document.body.removeChild(container);
            }
        }

        function importJSON(file){
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e){
                try{
                    const parsed = JSON.parse(e.target.result);
                    if(!Array.isArray(parsed)) throw new Error('JSON æ ¼å¼éŒ¯èª¤ï¼ˆéœ€ç‚ºé™£åˆ—ï¼‰');
                    // Basic validation and normalize
                    const normalized = parsed.map(item => ({
                        id: item.id || (Date.now()+Math.floor(Math.random()*999)),
                        subject: item.subject || 'æœªå‘½å',
                        chapter: item.chapter || '',
                        questions: Number(item.questions) || 0,
                        completed: !!item.completed,
                        corrected: !!item.corrected,
                        dueDate: item.dueDate || null,
                        srsLevel: item.srsLevel || 0,
                        srsLastReview: item.srsLastReview || null,
                        srsNextReview: item.srsNextReview || null,
                        srsPerformance: item.srsPerformance || []
                    }));
                    if(confirm('åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰æ¸…å–®ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                        exams = normalized;
                        saveExams(); render();
                        alert('åŒ¯å…¥å®Œæˆ');
                    }
                } catch(err){
                    alert('è®€å– JSON ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // ==================== SRS (Spaced Repetition System) FUNCTIONS ====================
        
        // SRS intervals in days: 1, 3, 7, 14, 30, 60, 120, 180
        const SRS_INTERVALS = [1, 3, 7, 14, 30, 60, 120, 180];
        
        // Advanced SRS settings
        const SRS_ADVANCED_MODE = true; // Enable advanced features
        const SRS_PERFORMANCE_THRESHOLD = 0.7; // 70% correct rate threshold

        // Generate SRS plan without applying it
        function generateSRSPlan() {
            if (!exams || exams.length === 0) {
                return { changes: [], updatedCount: 0, rescheduledCount: 0, newPlansCount: 0 };
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let updatedCount = 0;
            let rescheduledCount = 0;
            let newPlansCount = 0;
            const changes = [];
            
            exams.forEach(exam => {
                // Initialize SRS data if not present
                if (exam.srsLevel === undefined) exam.srsLevel = 0;
                if (!exam.srsLastReview) exam.srsLastReview = null;
                if (!exam.srsNextReview) exam.srsNextReview = null;
                if (!exam.srsPerformance) exam.srsPerformance = [];

                // Enhanced AI Planning Logic
                // 1. Plan for completed exams without a next review date
                if (exam.completed && !exam.srsNextReview) {
                    const nextReviewDate = new Date(today);
                    const interval = SRS_INTERVALS[Math.min(exam.srsLevel, SRS_INTERVALS.length - 1)];
                    nextReviewDate.setDate(nextReviewDate.getDate() + interval);
                    
                    const newDate = formatDate(nextReviewDate);
                    changes.push({
                        id: exam.id,
                        subject: exam.subject,
                        chapter: exam.chapter,
                        oldDate: exam.dueDate,
                        newDate: newDate,
                        srsLevel: exam.srsLevel,
                        reason: 'æ–°å¢è¤‡ç¿’è¨ˆç•«',
                        type: 'new'
                    });
                    newPlansCount++;
                }
                
                // 2. Advanced: Reschedule overdue items to today
                if (exam.srsNextReview && exam.completed) {
                    const reviewDate = new Date(exam.srsNextReview);
                    reviewDate.setHours(0, 0, 0, 0);
                    
                    // If significantly overdue (>7 days), bring it back
                    const daysDiff = Math.floor((today - reviewDate) / (1000 * 60 * 60 * 24));
                    if (daysDiff > 7) {
                        changes.push({
                            id: exam.id,
                            subject: exam.subject,
                            chapter: exam.chapter,
                            oldDate: exam.srsNextReview,
                            newDate: formatDate(today),
                            srsLevel: exam.srsLevel,
                            reason: `å·²é€¾æœŸ ${daysDiff} å¤©ï¼Œé‡æ–°å®‰æ’`,
                            type: 'reschedule'
                        });
                        rescheduledCount++;
                    }
                }
                
                // 3. Experimental: Plan for uncompleted exams without due date
                if (!exam.completed && !exam.dueDate) {
                    const planDate = new Date(today);
                    planDate.setDate(planDate.getDate() + 3); // Default 3 days from now
                    
                    changes.push({
                        id: exam.id,
                        subject: exam.subject,
                        chapter: exam.chapter,
                        oldDate: null,
                        newDate: formatDate(planDate),
                        srsLevel: 0,
                        reason: 'æœªå®Œæˆé …ç›®è‡ªå‹•è¦åŠƒ',
                        type: 'auto'
                    });
                    updatedCount++;
                }
            });
            
            return { changes, updatedCount, rescheduledCount, newPlansCount };
        }
        
        // Apply SRS plan changes
        function applySRSPlan(changes) {
            changes.forEach(change => {
                const exam = exams.find(e => e.id === change.id);
                if (exam) {
                    exam.dueDate = change.newDate;
                    if (exam.completed) {
                        exam.srsNextReview = change.newDate;
                    }
                }
            });
            saveExams();
            render();
        }
        
        // Store references for global functions
        window._applySRSPlan = applySRSPlan;
        window._exams = exams;
        window._saveExams = saveExams;
        window._render = render;
        
        // Show SRS planning preview dialog
        function srsAutoPlan() {
            const plan = generateSRSPlan();
            
            if (plan.changes.length === 0) {
                alert('æ²’æœ‰éœ€è¦è¦åŠƒçš„è€ƒå·');
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'srs-plan-modal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s';
            
            const content = document.createElement('div');
            content.style.cssText = 'background:var(--container-bg);padding:24px;border-radius:12px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,0.3)';
            
            let html = `
                <h2 style="margin:0 0 16px 0;color:var(--header-color)">ğŸ“‹ SRS è‡ªå‹•è¦åŠƒé è¦½</h2>
                <div style="margin-bottom:20px;padding:12px;background:var(--secondary-color);border-radius:8px;">
                    <div style="font-weight:bold;margin-bottom:8px">ğŸ“Š è¦åŠƒæ‘˜è¦</div>
                    <div>æ–°å¢è¤‡ç¿’è¨ˆç•«: <strong>${plan.newPlansCount}</strong></div>
                    <div>é‡æ–°å®‰æ’é€¾æœŸ: <strong>${plan.rescheduledCount}</strong></div>
                    <div>è‡ªå‹•è¦åŠƒæœªå®Œæˆ: <strong>${plan.updatedCount}</strong></div>
                    <div>ç¸½è¨ˆè®Šæ›´: <strong>${plan.changes.length}</strong></div>
                </div>
                <div style="margin-bottom:20px;">
                    <div style="font-weight:bold;margin-bottom:12px">ğŸ“ è¦åŠƒè©³æƒ… (å¯ç·¨è¼¯åˆ°æœŸæ—¥)</div>
                    <div id="plan-items-container">
            `;
            
            plan.changes.forEach((change, index) => {
                const typeColor = change.type === 'new' ? '#27ae60' : change.type === 'reschedule' ? '#e67e22' : '#3498db';
                html += `
                    <div style="border:1px solid var(--border-color);border-radius:8px;padding:12px;margin-bottom:10px;background:var(--container-bg)">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                            <div style="flex:1">
                                <div style="font-weight:bold;color:var(--header-color)">${change.subject} - ${change.chapter}</div>
                                <div style="font-size:12px;color:${typeColor};margin-top:4px">${change.reason}</div>
                            </div>
                            <span style="background:${typeColor};color:white;padding:4px 8px;border-radius:4px;font-size:11px;white-space:nowrap">SRS ${change.srsLevel}</span>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;font-size:13px">
                            <div>
                                <div style="color:var(--muted);font-size:11px">åŸåˆ°æœŸæ—¥</div>
                                <div>${change.oldDate || 'æœªè¨­å®š'}</div>
                            </div>
                            <div style="color:var(--primary-color);font-weight:bold">â†’</div>
                            <div>
                                <div style="color:var(--muted);font-size:11px">æ–°åˆ°æœŸæ—¥</div>
                                <input type="date" 
                                    class="srs-plan-date" 
                                    data-change-index="${index}" 
                                    value="${change.newDate}" 
                                    style="padding:6px;border:1px solid var(--border-color);border-radius:4px;background:var(--container-bg);color:var(--text-color);width:100%" />
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                <div style="display:flex;gap:12px;justify-content:flex-end">
                    <button id="srs-cancel-btn" style="padding:10px 20px;border:1px solid var(--border-color);border-radius:8px;background:var(--secondary-color);color:var(--text-color);cursor:pointer;font-size:14px">å–æ¶ˆ</button>
                    <button id="srs-apply-btn" style="padding:10px 20px;border:none;border-radius:8px;background:var(--primary-color);color:white;cursor:pointer;font-size:14px;font-weight:bold">å¥—ç”¨è¦åŠƒ</button>
                </div>
            `;
            
            content.innerHTML = html;
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Store plan data globally for access in button handlers
            window.currentSRSPlan = plan.changes;
            
            // Add event listeners
            document.getElementById('srs-cancel-btn').addEventListener('click', window.closeSRSPlanModal);
            document.getElementById('srs-apply-btn').addEventListener('click', window.applyAndCloseSRSPlan);
            
            // Add listeners for date inputs
            document.querySelectorAll('.srs-plan-date').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-change-index'));
                    window.updatePlanChange(index, this.value);
                });
            });
        }
        

        function advanceSRSLevel(examId) {
            const exam = exams.find(e => e.id === examId);
            if (!exam) return;

            if (exam.srsLevel === undefined) exam.srsLevel = 0;
            if (!exam.srsPerformance) exam.srsPerformance = [];
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            exam.srsLastReview = formatDate(today);
            exam.srsLevel = Math.min(exam.srsLevel + 1, SRS_INTERVALS.length - 1);
            
            // Track performance (assuming good performance when advancing)
            exam.srsPerformance.push({
                date: formatDate(today),
                level: exam.srsLevel,
                result: 'good'
            });
            
            // Keep only last 10 performance records
            if (exam.srsPerformance.length > 10) {
                exam.srsPerformance = exam.srsPerformance.slice(-10);
            }
            
            const nextReviewDate = new Date(today);
            const interval = SRS_INTERVALS[exam.srsLevel];
            nextReviewDate.setDate(nextReviewDate.getDate() + interval);
            
            exam.srsNextReview = formatDate(nextReviewDate);
            exam.dueDate = exam.srsNextReview;
            
            saveExams();
            render();
        }

        function decreaseSRSLevel(examId) {
            const exam = exams.find(e => e.id === examId);
            if (!exam) return;

            if (exam.srsLevel === undefined) exam.srsLevel = 0;
            if (!exam.srsPerformance) exam.srsPerformance = [];
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            exam.srsLastReview = formatDate(today);
            // Decrease level but don't go below 0
            exam.srsLevel = Math.max(exam.srsLevel - 1, 0);
            
            // Track performance (poor performance when decreasing)
            exam.srsPerformance.push({
                date: formatDate(today),
                level: exam.srsLevel,
                result: 'poor'
            });
            
            // Keep only last 10 performance records
            if (exam.srsPerformance.length > 10) {
                exam.srsPerformance = exam.srsPerformance.slice(-10);
            }
            
            const nextReviewDate = new Date(today);
            const interval = SRS_INTERVALS[exam.srsLevel];
            nextReviewDate.setDate(nextReviewDate.getDate() + interval);
            
            exam.srsNextReview = formatDate(nextReviewDate);
            exam.dueDate = exam.srsNextReview;
            
            saveExams();
            render();
        }

        async function exportSRSReport() {
            // Check if jsPDF is available
            if (!window.jspdf && !window.jsPDF) {
                alert('PDF åŒ¯å‡ºåŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }
            const { jsPDF } = window.jspdf || window;
            
            // Create a temporary container for rendering
            const container = document.createElement('div');
            container.style.cssText = 'position:absolute;left:-9999px;top:0;width:800px;background:white;padding:30px;font-family:Arial,sans-serif;';
            document.body.appendChild(container);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Calculate enhanced SRS statistics
            const srsExams = exams.filter(e => e.srsLevel !== undefined && e.srsLevel > 0);
            const dueToday = srsExams.filter(e => {
                if (!e.srsNextReview) return false;
                const reviewDate = new Date(e.srsNextReview);
                reviewDate.setHours(0, 0, 0, 0);
                return reviewDate.getTime() === today.getTime();
            }).length;
            
            const overdue = srsExams.filter(e => {
                if (!e.srsNextReview) return false;
                const reviewDate = new Date(e.srsNextReview);
                reviewDate.setHours(0, 0, 0, 0);
                return reviewDate < today;
            }).length;
            
            const upcoming = srsExams.filter(e => {
                if (!e.srsNextReview) return false;
                const reviewDate = new Date(e.srsNextReview);
                reviewDate.setHours(0, 0, 0, 0);
                const diffDays = Math.ceil((reviewDate - today) / (1000 * 60 * 60 * 24));
                return diffDays > 0 && diffDays <= 7;
            }).length;
            
            // Calculate level distribution
            const levelDist = {};
            srsExams.forEach(e => {
                const level = e.srsLevel || 0;
                levelDist[level] = (levelDist[level] || 0) + 1;
            });
            
            // Calculate performance stats
            let totalReviews = 0;
            let goodReviews = 0;
            srsExams.forEach(e => {
                if (e.srsPerformance && Array.isArray(e.srsPerformance)) {
                    totalReviews += e.srsPerformance.length;
                    goodReviews += e.srsPerformance.filter(p => p.result === 'good').length;
                }
            });
            const performanceRate = totalReviews > 0 ? Math.round((goodReviews / totalReviews) * 100) : 0;
            
            // Build enhanced HTML content
            let html = `
                <div style="text-align:center;font-size:24px;font-weight:bold;margin-bottom:20px;color:#2c3e50;">
                    SRS è¤‡ç¿’å ±å‘Šï¼ˆé€²éšç‰ˆï¼‰
                </div>
                <div style="font-size:14px;margin-bottom:25px;line-height:1.8;color:#333;border:2px solid #3498db;border-radius:8px;padding:15px;background:#f8f9fa;">
                    <div style="font-weight:bold;font-size:16px;margin-bottom:10px;color:#2c3e50;">ğŸ“Š ç¸½é«”çµ±è¨ˆ</div>
                    <div>å ±å‘Šæ—¥æœŸ: ${formatDate(today)}</div>
                    <div>ç¸½è¤‡ç¿’é …ç›®: <strong>${srsExams.length}</strong></div>
                    <div>ä»Šæ—¥åˆ°æœŸ: <strong style="color:#f39c12">${dueToday}</strong> | å·²éæœŸ: <strong style="color:#e74c3c">${overdue}</strong> | ä¸ƒå¤©å…§: <strong style="color:#27ae60">${upcoming}</strong></div>
                    ${totalReviews > 0 ? `<div>ç¸½è¤‡ç¿’æ¬¡æ•¸: ${totalReviews} | è¡¨ç¾è‰¯å¥½ç‡: <strong style="color:#27ae60">${performanceRate}%</strong></div>` : ''}
                </div>
                <div style="font-size:14px;margin-bottom:20px;line-height:1.8;color:#333;">
                    <div style="font-weight:bold;font-size:16px;margin-bottom:10px;color:#2c3e50;">ğŸ“ˆ ç­‰ç´šåˆ†å¸ƒ</div>
                    ${Object.keys(levelDist).sort((a, b) => Number(b) - Number(a)).map(level => 
                        `<div style="margin-bottom:5px;">Level ${level}: <strong>${levelDist[level]}</strong> é … (é–“éš” ${SRS_INTERVALS[level]} å¤©)</div>`
                    ).join('')}
                </div>
                <div style="font-size:16px;font-weight:bold;margin-bottom:12px;color:#2c3e50;border-top:2px solid #ddd;padding-top:15px;">
                    ğŸ“š SRS è¤‡ç¿’æ¸…å–®
                </div>
            `;
            
            // Add SRS exam cards sorted by review date
            const sortedSrsExams = srsExams.slice().sort((a, b) => {
                if (!a.srsNextReview && !b.srsNextReview) return 0;
                if (!a.srsNextReview) return 1;
                if (!b.srsNextReview) return -1;
                return new Date(a.srsNextReview) - new Date(b.srsNextReview);
            });
            
            sortedSrsExams.forEach((exam) => {
                const reviewDate = exam.srsNextReview ? new Date(exam.srsNextReview) : null;
                let bgColor = '#fafafa';
                let statusText = 'SRS Level ' + exam.srsLevel;
                let statusIcon = 'ğŸ“–';
                
                if (reviewDate) {
                    reviewDate.setHours(0, 0, 0, 0);
                    if (reviewDate < today) {
                        bgColor = '#ffe6e6';
                        statusText += ' - å·²éæœŸ';
                        statusIcon = 'âš ï¸';
                    } else if (reviewDate.getTime() === today.getTime()) {
                        bgColor = '#fff3cd';
                        statusText += ' - ä»Šæ—¥è¤‡ç¿’';
                        statusIcon = 'â°';
                    } else {
                        bgColor = '#e6fae6';
                        statusIcon = 'âœ…';
                    }
                }
                
                const nextReviewText = exam.srsNextReview || "æœªè¨­å®š";
                const lastReviewText = exam.srsLastReview || "æœªè¨˜éŒ„";
                
                // Performance history
                let perfHtml = '';
                if (exam.srsPerformance && exam.srsPerformance.length > 0) {
                    const recent = exam.srsPerformance.slice(-3);
                    perfHtml = `<div style="font-size:11px;color:#666;margin-top:4px;">è¿‘æœŸè¡¨ç¾: ${recent.map(p => p.result === 'good' ? 'âœ“' : 'âœ—').join(' ')}</div>`;
                }
                
                html += `
                    <div style="border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:12px;background:${bgColor};">
                        <div style="font-size:16px;font-weight:bold;margin-bottom:8px;color:#2c3e50;">${statusIcon} ${exam.subject} - ${exam.chapter}</div>
                        <div style="font-size:12px;line-height:1.6;color:#555;">
                            <div>é¡Œæ•¸: ${exam.questions}</div>
                            <div style="font-weight:bold;">ç‹€æ…‹: ${statusText}</div>
                            <div>ä¸Šæ¬¡è¤‡ç¿’: ${lastReviewText}</div>
                            <div>ä¸‹æ¬¡è¤‡ç¿’: ${nextReviewText}</div>
                            ${perfHtml}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Render to canvas with html2canvas (supports Chinese fonts)
            try {
                const canvas = await html2canvas(container, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false
                });
                
                // Create PDF and add the rendered image
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // If content is too tall, split into multiple pages
                const pageHeight = 295; // A4 height in mm
                let heightLeft = imgHeight;
                let position = 0;
                
                doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                doc.save('srs_report_advanced.pdf');
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('SRS å ±å‘ŠåŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                // Clean up
                document.body.removeChild(container);
            }
        }

        // ============== EXPERIMENTAL AUTO-PLANNING FEATURES ==============
        
        // Intelligent workload balancing - distributes exams evenly over time
        function experimentalWorkloadBalancing() {
            const incomplete = exams.filter(e => !e.completed);
            if (incomplete.length === 0) {
                alert('æ²’æœ‰æœªå®Œæˆçš„è€ƒå·å¯ä»¥è¦åŠƒ');
                return;
            }
            
            const days = parseInt(prompt('è«‹è¼¸å…¥è¦åˆ†é…çš„å¤©æ•¸ï¼ˆå»ºè­° 7-30 å¤©ï¼‰:', '14'));
            if (!days || days < 1) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Calculate total questions
            const totalQuestions = incomplete.reduce((sum, e) => sum + e.questions, 0);
            const questionsPerDay = Math.ceil(totalQuestions / days);
            
            // Sort by subject for better distribution
            const sorted = [...incomplete].sort((a, b) => a.subject.localeCompare(b.subject));
            
            const changes = [];
            let currentDay = 0;
            let currentDayQuestions = 0;
            
            sorted.forEach(exam => {
                if (currentDayQuestions >= questionsPerDay && currentDay < days - 1) {
                    currentDay++;
                    currentDayQuestions = 0;
                }
                
                const planDate = new Date(today);
                planDate.setDate(planDate.getDate() + currentDay);
                
                changes.push({
                    id: exam.id,
                    subject: exam.subject,
                    chapter: exam.chapter,
                    oldDate: exam.dueDate,
                    newDate: formatDate(planDate),
                    srsLevel: exam.srsLevel || 0,
                    reason: `å·¥ä½œé‡å¹³è¡¡ (ç¬¬ ${currentDay + 1} å¤©, ${currentDayQuestions + exam.questions}/${questionsPerDay} é¡Œ)`,
                    type: 'balance'
                });
                
                currentDayQuestions += exam.questions;
            });
            
            showPlanPreview(changes, 'ğŸ”„ å·¥ä½œé‡å¹³è¡¡è¦åŠƒ');
        }
        
        // Priority-based planning - urgent items first
        function experimentalPriorityPlanning() {
            const incomplete = exams.filter(e => !e.completed);
            if (incomplete.length === 0) {
                alert('æ²’æœ‰æœªå®Œæˆçš„è€ƒå·å¯ä»¥è¦åŠƒ');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Categorize exams
            const urgent = incomplete.filter(e => {
                if (!e.dueDate) return false;
                const due = new Date(e.dueDate);
                const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                return diff <= 3 && diff >= 0;
            });
            
            const noDueDate = incomplete.filter(e => !e.dueDate);
            const scheduled = incomplete.filter(e => {
                if (!e.dueDate) return false;
                const due = new Date(e.dueDate);
                const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                return diff > 3;
            });
            
            const changes = [];
            
            // Keep urgent items as is or move to today if overdue
            urgent.forEach(exam => {
                const due = new Date(exam.dueDate);
                if (due < today) {
                    changes.push({
                        id: exam.id,
                        subject: exam.subject,
                        chapter: exam.chapter,
                        oldDate: exam.dueDate,
                        newDate: formatDate(today),
                        srsLevel: exam.srsLevel || 0,
                        reason: 'ç·Šæ€¥é …ç›® - å·²éæœŸï¼Œç§»è‡³ä»Šå¤©',
                        type: 'urgent'
                    });
                }
            });
            
            // Distribute items without due date over next week
            noDueDate.forEach((exam, index) => {
                const planDate = new Date(today);
                planDate.setDate(planDate.getDate() + (index % 7) + 1);
                
                changes.push({
                    id: exam.id,
                    subject: exam.subject,
                    chapter: exam.chapter,
                    oldDate: null,
                    newDate: formatDate(planDate),
                    srsLevel: exam.srsLevel || 0,
                    reason: 'ç„¡åˆ°æœŸæ—¥ - åˆ†é…è‡³æœªä¾†ä¸€é€±',
                    type: 'auto'
                });
            });
            
            showPlanPreview(changes, 'âš¡ å„ªå…ˆç´šè¦åŠƒ');
        }
        
        // Subject rotation planning - alternate between subjects
        function experimentalSubjectRotation() {
            const incomplete = exams.filter(e => !e.completed);
            if (incomplete.length === 0) {
                alert('æ²’æœ‰æœªå®Œæˆçš„è€ƒå·å¯ä»¥è¦åŠƒ');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Group by subject
            const bySubject = {};
            incomplete.forEach(exam => {
                if (!bySubject[exam.subject]) bySubject[exam.subject] = [];
                bySubject[exam.subject].push(exam);
            });
            
            const subjects = Object.keys(bySubject);
            const changes = [];
            let dayOffset = 0;
            
            // Rotate through subjects
            let hasMore = true;
            let subjectIndex = 0;
            
            while (hasMore) {
                hasMore = false;
                
                for (let i = 0; i < subjects.length; i++) {
                    const subject = subjects[i];
                    const examsInSubject = bySubject[subject];
                    
                    if (examsInSubject.length > 0) {
                        hasMore = true;
                        const exam = examsInSubject.shift();
                        
                        const planDate = new Date(today);
                        planDate.setDate(planDate.getDate() + dayOffset);
                        
                        changes.push({
                            id: exam.id,
                            subject: exam.subject,
                            chapter: exam.chapter,
                            oldDate: exam.dueDate,
                            newDate: formatDate(planDate),
                            srsLevel: exam.srsLevel || 0,
                            reason: `ç§‘ç›®è¼ªæ›¿ - ç¬¬ ${dayOffset + 1} å¤©`,
                            type: 'rotation'
                        });
                        
                        dayOffset++;
                    }
                }
            }
            
            showPlanPreview(changes, 'ğŸ”€ ç§‘ç›®è¼ªæ›¿è¦åŠƒ');
        }
        
        // Generic plan preview function
        function showPlanPreview(changes, title) {
            if (changes.length === 0) {
                alert('æ²’æœ‰éœ€è¦è®Šæ›´çš„é …ç›®');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'exp-plan-modal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s';
            
            const content = document.createElement('div');
            content.style.cssText = 'background:var(--container-bg);padding:24px;border-radius:12px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,0.3)';
            
            let html = `
                <h2 style="margin:0 0 16px 0;color:var(--header-color)">${title}</h2>
                <div style="margin-bottom:20px;padding:12px;background:var(--secondary-color);border-radius:8px;">
                    <div style="font-weight:bold;margin-bottom:8px">ğŸ“Š è¦åŠƒæ‘˜è¦</div>
                    <div>ç¸½è¨ˆè®Šæ›´: <strong>${changes.length}</strong> é …</div>
                </div>
                <div style="margin-bottom:20px;">
                    <div style="font-weight:bold;margin-bottom:12px">ğŸ“ è¦åŠƒè©³æƒ… (å¯ç·¨è¼¯åˆ°æœŸæ—¥)</div>
                    <div id="exp-plan-items-container">
            `;
            
            changes.forEach((change, index) => {
                const typeColors = {
                    balance: '#3498db',
                    urgent: '#e74c3c',
                    auto: '#27ae60',
                    rotation: '#9b59b6'
                };
                const typeColor = typeColors[change.type] || '#95a5a6';
                
                html += `
                    <div style="border:1px solid var(--border-color);border-radius:8px;padding:12px;margin-bottom:10px;background:var(--container-bg)">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                            <div style="flex:1">
                                <div style="font-weight:bold;color:var(--header-color)">${change.subject} - ${change.chapter}</div>
                                <div style="font-size:12px;color:${typeColor};margin-top:4px">${change.reason}</div>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;font-size:13px">
                            <div>
                                <div style="color:var(--muted);font-size:11px">åŸåˆ°æœŸæ—¥</div>
                                <div>${change.oldDate || 'æœªè¨­å®š'}</div>
                            </div>
                            <div style="color:var(--primary-color);font-weight:bold">â†’</div>
                            <div>
                                <div style="color:var(--muted);font-size:11px">æ–°åˆ°æœŸæ—¥</div>
                                <input type="date" 
                                    data-exp-change-index="${index}" 
                                    value="${change.newDate}" 
                                    style="padding:6px;border:1px solid var(--border-color);border-radius:4px;background:var(--container-bg);color:var(--text-color);width:100%" />
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                <div style="display:flex;gap:12px;justify-content:flex-end">
                    <button id="exp-cancel-btn" style="padding:10px 20px;border:1px solid var(--border-color);border-radius:8px;background:var(--secondary-color);color:var(--text-color);cursor:pointer;font-size:14px">å–æ¶ˆ</button>
                    <button id="exp-apply-btn" style="padding:10px 20px;border:none;border-radius:8px;background:var(--primary-color);color:white;cursor:pointer;font-size:14px;font-weight:bold">å¥—ç”¨è¦åŠƒ</button>
                </div>
            `;
            
            content.innerHTML = html;
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            window.currentExpPlan = changes;
            
            // Add event listeners
            document.getElementById('exp-cancel-btn').addEventListener('click', window.closeExpPlanModal);
            document.getElementById('exp-apply-btn').addEventListener('click', window.applyAndCloseExpPlan);
            
            // Add listeners for date inputs
            document.querySelectorAll('[data-exp-change-index]').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-exp-change-index'));
                    window.updateExpPlanChange(index, this.value);
                });
            });
        }

        
        // Show experimental planning options
        window.showExperimentalPlanningMenu = function() {
            const modal = document.createElement('div');
            modal.id = 'exp-menu-modal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s';
            
            const content = document.createElement('div');
            content.style.cssText = 'background:var(--container-bg);padding:24px;border-radius:12px;max-width:600px;width:90%;box-shadow:0 24px 64px rgba(0,0,0,0.3)';
            
            content.innerHTML = `
                <h2 style="margin:0 0 16px 0;color:var(--header-color)">ğŸ§ª å¯¦é©—æ€§è‡ªå‹•è¦åŠƒåŠŸèƒ½</h2>
                <p style="color:var(--muted);margin-bottom:20px;font-size:14px">é¸æ“‡ä¸€å€‹è¦åŠƒç­–ç•¥ä¾†è‡ªå‹•å®‰æ’ä½ çš„è€ƒå·</p>
                
                <div style="display:flex;flex-direction:column;gap:12px">
                    <button id="exp-workload-btn" style="padding:16px;border:1px solid var(--border-color);border-radius:8px;background:var(--container-bg);color:var(--text-color);cursor:pointer;text-align:left;transition:all 0.2s" onmouseover="this.style.background='var(--secondary-color)'" onmouseout="this.style.background='var(--container-bg)'">
                        <div style="font-weight:bold;font-size:16px;margin-bottom:4px">ğŸ”„ å·¥ä½œé‡å¹³è¡¡è¦åŠƒ</div>
                        <div style="font-size:13px;color:var(--muted)">å°‡æ‰€æœ‰æœªå®Œæˆçš„è€ƒå·å‡å‹»åˆ†é…åˆ°æŒ‡å®šå¤©æ•¸å…§ï¼Œç¢ºä¿æ¯å¤©å·¥ä½œé‡ç›¸è¿‘</div>
                    </button>
                    
                    <button id="exp-priority-btn" style="padding:16px;border:1px solid var(--border-color);border-radius:8px;background:var(--container-bg);color:var(--text-color);cursor:pointer;text-align:left;transition:all 0.2s" onmouseover="this.style.background='var(--secondary-color)'" onmouseout="this.style.background='var(--container-bg)'">
                        <div style="font-weight:bold;font-size:16px;margin-bottom:4px">âš¡ å„ªå…ˆç´šè¦åŠƒ</div>
                        <div style="font-size:13px;color:var(--muted)">æ ¹æ“šåˆ°æœŸæ—¥ç·Šæ€¥ç¨‹åº¦è‡ªå‹•å®‰æ’ï¼Œå„ªå…ˆè™•ç†å³å°‡åˆ°æœŸçš„é …ç›®</div>
                    </button>
                    
                    <button id="exp-rotation-btn" style="padding:16px;border:1px solid var(--border-color);border-radius:8px;background:var(--container-bg);color:var(--text-color);cursor:pointer;text-align:left;transition:all 0.2s" onmouseover="this.style.background='var(--secondary-color)'" onmouseout="this.style.background='var(--container-bg)'">
                        <div style="font-weight:bold;font-size:16px;margin-bottom:4px">ğŸ”€ ç§‘ç›®è¼ªæ›¿è¦åŠƒ</div>
                        <div style="font-size:13px;color:var(--muted)">äº¤æ›¿å®‰æ’ä¸åŒç§‘ç›®çš„è€ƒå·ï¼Œé¿å…å–®ä¸€ç§‘ç›®éæ–¼å¯†é›†</div>
                    </button>
                </div>
                
                <div style="margin-top:20px;display:flex;justify-content:flex-end">
                    <button id="exp-menu-close-btn" style="padding:10px 20px;border:1px solid var(--border-color);border-radius:8px;background:var(--secondary-color);color:var(--text-color);cursor:pointer;font-size:14px">é—œé–‰</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Add event listeners after appending to DOM
            document.getElementById('exp-workload-btn').addEventListener('click', () => {
                window.closeExpMenu();
                experimentalWorkloadBalancing();
            });
            document.getElementById('exp-priority-btn').addEventListener('click', () => {
                window.closeExpMenu();
                experimentalPriorityPlanning();
            });
            document.getElementById('exp-rotation-btn').addEventListener('click', () => {
                window.closeExpMenu();
                experimentalSubjectRotation();
            });
            document.getElementById('exp-menu-close-btn').addEventListener('click', window.closeExpMenu);
        };


        // ==================== END EXPERIMENTAL PLANNING ====================


        G.sortByQuestionsBtn.addEventListener('click', () => { sortState.key = 'questions'; sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; render(); });
        G.sortByChapterBtn.addEventListener('click', () => { sortState.key = 'chapter'; sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; render(); });
        G.sortByDueBtn.addEventListener('click', () => { sortState.key = 'dueDate'; sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; render(); });
        G.toggleCardViewBtn.addEventListener('click', () => { cardViewMode = !cardViewMode; localStorage.setItem('cardViewMode', cardViewMode); render(); });
        G.searchBox.addEventListener('input', debounce(() => render(), 180));
        G.addBtn.addEventListener('click', addExam);
        G.exportAllIcs.addEventListener('click', () => downloadAllICS());
        G.exportJsonBtn.addEventListener('click', exportJSON);
        G.importJsonFile.addEventListener('change', (ev) => {
            const f = ev.target.files && ev.target.files[0];
            if(f) importJSON(f);
            ev.target.value = '';
        });
        G.themeToggle.addEventListener('click', () => {
            const current = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            applyTheme(current === 'light' ? 'dark' : 'light');
        });
        function applyTheme(t){
            if(t === 'dark') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', t);
        }
        G.clearStorageBtn.addEventListener('click', () => {
            if(confirm('ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿå„²å­˜çš„è€ƒå·è³‡æ–™ä¸¦å›å¾©é è¨­æ¸…å–®ï¼Ÿ')) {
                localStorage.removeItem('examsList');
                loadExams(); render();
            }
        });
        G.filterSelect.addEventListener('change', () => render());
        function debounce(fn, wait){ let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn(...a), wait); }; }

        // Pomodoro
        const pom = {
            durations: { pom:25*60, short:5*60, long:15*60 },
            timerId: null, remaining: 25*60, running: false, selectedExamId: null, cycles: 0,
        };

        // WebAudio setup for beep
        let audioCtx = null;
        function ensureAudioContext(){
            if(audioCtx) return audioCtx;
            try{
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }catch(e){
                audioCtx = null;
            }
            return audioCtx;
        }
        function playBeep(){
            if(!G.pom.enableSound.checked) return;
            const ctx = ensureAudioContext();
            if(!ctx) return;
            if (ctx.state === 'suspended') {
                // some browsers require resume by user gesture; try to resume
                ctx.resume().catch(()=>{});
            }
            // Continuous beeps - play 5 beeps with pauses
            const now = ctx.currentTime;
            for(let i = 0; i < 5; i++){
                const beepStart = now + (i * 0.5);
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'sine';
                o.frequency.value = 880;
                o.connect(g);
                g.connect(ctx.destination);
                g.gain.setValueAtTime(0.001, beepStart);
                g.gain.exponentialRampToValueAtTime(0.18, beepStart + 0.02);
                o.start(beepStart);
                g.gain.exponentialRampToValueAtTime(0.0001, beepStart + 0.35);
                o.stop(beepStart + 0.36);
            }
        }

        function selectPomodoroExam(id){
            const exam = exams.find(e => e.id === id);
            if(!exam){ G.pom.selected.textContent = 'ï¼ˆå°šæœªé¸æ“‡è€ƒå·ï¼‰'; return; }
            pom.selectedExamId = id;
            G.pom.selected.textContent = `ï½œ ${exam.subject} ${exam.chapter}`;
            const mode = G.pom.mode.value;
            pom.remaining = pom.durations[mode];
            updateTimerDisplay(); renderCycleDots();
        }
        function updateTimerDisplay(){
            const mm = Math.floor(pom.remaining/60), ss = pom.remaining % 60;
            G.pom.display.textContent = `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
            if(pom.remaining <= 10 && pom.running){
                G.pom.display.style.transform = 'scale(1.02)';
                setTimeout(()=> G.pom.display.style.transform = '', 220);
            }
        }
        function startPomodoro(){
            if(pom.timerId) return;
            pom.running = true;
            const mode = G.pom.mode.value;
            if(pom.remaining <= 0) pom.remaining = pom.durations[mode];
            pom.timerId = setInterval(() => {
                pom.remaining -= 1;
                if(pom.remaining <= 0){
                    clearInterval(pom.timerId); pom.timerId = null; pom.running = false;
                    if(mode === 'pom') pom.cycles++;
                    notifyUser('ç•ªèŒ„é˜çµæŸ', `æ¨¡å¼ ${mode} å·²å®Œæˆã€‚`);
                    playBeep();
                }
                updateTimerDisplay(); renderCycleDots();
            }, 1000);
            updateTimerDisplay();
        }
        function pausePomodoro(){
            if(pom.timerId){ clearInterval(pom.timerId); pom.timerId = null; pom.running = false; }
            else { startPomodoro(); }
        }
        function resetPomodoro(){
            const mode = G.pom.mode.value;
            if(pom.timerId){ clearInterval(pom.timerId); pom.timerId = null; }
            pom.running = false;
            pom.remaining = pom.durations[mode];
            updateTimerDisplay();
        }
        G.pom.start.addEventListener('click', () => { startPomodoro(); });
        G.pom.pause.addEventListener('click', pausePomodoro);
        G.pom.reset.addEventListener('click', resetPomodoro);
        G.pom.mode.addEventListener('change', () => {
            pom.remaining = pom.durations[G.pom.mode.value]; updateTimerDisplay();
        });
        function renderCycleDots(){
            const container = G.pom.cycle; container.innerHTML = '';
            for(let i=0;i<4;i++){
                const dot = document.createElement('div');
                dot.className = 'cycle-dot' + (i < pom.cycles ? ' active' : '');
                container.appendChild(dot);
            }
        }
        function notifyUser(title, body){
            try {
                if(Notification.permission === 'granted') new Notification(title, { body });
                else if(Notification.permission !== 'denied') Notification.requestPermission().then(p => { if(p === 'granted') new Notification(title,{body}); });
            } catch(e){}
            G.pom.display.style.transition = 'box-shadow .2s';
            G.pom.display.style.boxShadow = '0 8px 28px rgba(0,0,0,0.18)';
            setTimeout(()=> G.pom.display.style.boxShadow = '', 1200);
        }

        G.pom.close.addEventListener('click', () => {
            G.pom.panel.classList.add('hidden');
            localStorage.setItem('pomodoroHidden', 'true');
        });
        G.showPomodoroBtn.addEventListener('click', () => {
            G.pom.panel.classList.remove('hidden');
            localStorage.setItem('pomodoroHidden', 'false');
        });
        function initPomodoroVisibility() {
            if (localStorage.getItem('pomodoroHidden') === 'true') {
                G.pom.panel.classList.add('hidden');
            }
        }

        // Fullscreen display for pomodoro (custom fullscreen overlay)
        const pomFsContainer = document.getElementById('pom-fullscreen');
        G.pomFullscreenToggle.addEventListener('click', () => togglePomFullscreen());

        function togglePomFullscreen(){
            if(pomFsContainer.style.display === 'none' || pomFsContainer.style.display === ''){
                // open
                pomFsContainer.style.display = 'block';
                pomFsContainer.innerHTML = `
                <div class="pom-fullscreen" id="pomfs-outer">
                    <div class="pom-inner">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <strong style="font-size:22px">ç•ªèŒ„é˜ï¼ˆå…¨è¢å¹•ï¼‰</strong>
                            <div>
                                <button id="pomfs-close" style="margin-right:8px" class="theme-toggle">é—œé–‰</button>
                                <button id="pomfs-start" class="icon-btn">é–‹å§‹</button>
                            </div>
                        </div>
                        <div style="margin-top:20px">
                            <div id="pomfs-display" class="timer-display">25:00</div>
                            <div style="margin-top:12px">
                                <button id="pomfs-pause" class="theme-toggle">æš«åœ/ç¹¼çºŒ</button>
                                <button id="pomfs-reset" class="theme-toggle">é‡è¨­</button>
                            </div>
                            <div style="margin-top:12px">
                                <label class="small muted" style="display:flex;align-items:center;gap:8px;justify-content:center">
                                    <input type="checkbox" id="pomfs-enable-sound" /> å•Ÿç”¨éŸ³æ•ˆ
                                </label>
                            </div>
                        </div>
                    </div>
                </div>`;
                // hook buttons
                document.getElementById('pomfs-close').addEventListener('click', () => {
                    pomFsContainer.style.display = 'none';
                    pomFsContainer.innerHTML = '';
                });
                document.getElementById('pomfs-start').addEventListener('click', () => {
                    // sync sound checkbox
                    const fsSound = document.getElementById('pomfs-enable-sound');
                    fsSound.checked = G.pom.enableSound.checked;
                    startPomodoro();
                });
                document.getElementById('pomfs-pause').addEventListener('click', () => {
                    pausePomodoro();
                });
                document.getElementById('pomfs-reset').addEventListener('click', () => {
                    resetPomodoro();
                });
                // reflect display
                const fsDisplay = document.getElementById('pomfs-display');
                const fsInterval = setInterval(()=> {
                    fsDisplay.textContent = G.pom.display.textContent;
                    // sync the fs sound checkbox to main
                    const fsSound = document.getElementById('pomfs-enable-sound');
                    if(fsSound) fsSound.addEventListener('change', (e)=> { G.pom.enableSound.checked = e.target.checked; });
                    if(pomFsContainer.style.display === 'none') clearInterval(fsInterval);
                }, 300);
            } else {
                pomFsContainer.style.display = 'none';
                pomFsContainer.innerHTML = '';
            }
        }

        // initial load
        loadExams();
        cardViewMode = localStorage.getItem('cardViewMode') === 'true';
        applyTheme(localStorage.getItem('theme') || 'light');
        initPomodoroVisibility();
        render();
        renderCycleDots();
        setTimeout(()=> updateSummary(), 120);
        document.addEventListener('keydown', (e) => {
            if(e.code === 'Space' && document.activeElement.tagName !== 'INPUT'){
                e.preventDefault(); pausePomodoro();
            }
        });
        window.EXAM_APP = { exams, saveExams, loadExams, render, downloadAllICS, downloadICS };

        // ==================== SMART SCHEDULER SYSTEM ====================
        const scheduler = {
            settings: {
                dailyCapacity: 50,
                priorityMode: 'due-date',
                bufferDays: 2,
                onboardingComplete: false
            },
            schedule: []
        };

        function loadSchedulerSettings() {
            const saved = localStorage.getItem('schedulerSettings');
            if (saved) {
                scheduler.settings = { ...scheduler.settings, ...JSON.parse(saved) };
            }
        }

        function saveSchedulerSettings() {
            localStorage.setItem('schedulerSettings', JSON.stringify(scheduler.settings));
        }

        function loadSchedule() {
            const saved = localStorage.getItem('scheduleData');
            if (saved) {
                scheduler.schedule = JSON.parse(saved);
            }
        }

        function saveSchedule() {
            localStorage.setItem('scheduleData', JSON.stringify(scheduler.schedule));
        }

        // Smart scheduling algorithm
        function generateSchedule() {
            const { dailyCapacity, priorityMode, bufferDays } = scheduler.settings;
            
            // Filter incomplete exams
            const incomplete = exams.filter(e => !e.completed);
            if (incomplete.length === 0) {
                scheduler.schedule = [];
                saveSchedule();
                return;
            }

            // Sort by priority
            let sorted = [...incomplete];
            if (priorityMode === 'due-date') {
                sorted.sort((a, b) => {
                    if (!a.dueDate && !b.dueDate) return 0;
                    if (!a.dueDate) return 1;
                    if (!b.dueDate) return -1;
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });
            } else if (priorityMode === 'balanced') {
                // Balance between due date and question count
                sorted.sort((a, b) => {
                    const urgencyA = a.dueDate ? (new Date(a.dueDate) - new Date()) / (24*3600*1000) : 999;
                    const urgencyB = b.dueDate ? (new Date(b.dueDate) - new Date()) / (24*3600*1000) : 999;
                    const scoreA = urgencyA / Math.max(1, a.questions);
                    const scoreB = urgencyB / Math.max(1, b.questions);
                    return scoreA - scoreB;
                });
            } else if (priorityMode === 'subject-rotation') {
                // Rotate subjects to avoid monotony
                const subjectOrder = {};
                let order = 0;
                sorted.sort((a, b) => {
                    if (!subjectOrder[a.subject]) subjectOrder[a.subject] = order++;
                    if (!subjectOrder[b.subject]) subjectOrder[b.subject] = order++;
                    return subjectOrder[a.subject] - subjectOrder[b.subject];
                });
            }

            // Generate daily schedule
            const schedule = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let dayOffset = 0;
            let examQueue = [...sorted];

            while (examQueue.length > 0) {
                const currentDay = new Date(today);
                currentDay.setDate(currentDay.getDate() + dayOffset);
                
                const daySchedule = {
                    date: currentDay.toISOString().split('T')[0],
                    items: [],
                    totalQuestions: 0
                };

                let remainingCapacity = dailyCapacity;
                
                while (remainingCapacity > 0 && examQueue.length > 0) {
                    const exam = examQueue[0];
                    const examQuestions = exam.questions;

                    // Check if exam can fit in remaining capacity
                    if (examQuestions <= remainingCapacity) {
                        // Add entire exam
                        daySchedule.items.push({
                            id: exam.id,
                            subject: exam.subject,
                            chapter: exam.chapter,
                            questions: examQuestions,
                            dueDate: exam.dueDate,
                            partial: false
                        });
                        daySchedule.totalQuestions += examQuestions;
                        remainingCapacity -= examQuestions;
                        examQueue.shift();
                    } else if (remainingCapacity >= 10) {
                        // Split exam if remaining capacity is enough for meaningful work
                        daySchedule.items.push({
                            id: exam.id,
                            subject: exam.subject,
                            chapter: exam.chapter,
                            questions: remainingCapacity,
                            dueDate: exam.dueDate,
                            partial: true,
                            remaining: examQuestions - remainingCapacity
                        });
                        daySchedule.totalQuestions += remainingCapacity;
                        exam.questions -= remainingCapacity;
                        remainingCapacity = 0;
                    } else {
                        // Not enough capacity for meaningful work, move to next day
                        break;
                    }
                }

                if (daySchedule.items.length > 0) {
                    schedule.push(daySchedule);
                }

                dayOffset++;
                
                // Safety limit: don't schedule more than 90 days out
                if (dayOffset > 90) break;
            }

            scheduler.schedule = schedule;
            saveSchedule();
            renderSchedule();
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            if (!container) return;

            if (scheduler.schedule.length === 0) {
                container.innerHTML = '<div class="small muted">ç›®å‰æ²’æœ‰éœ€è¦æ’ç¨‹çš„è€ƒå·ï¼Œè«‹å…ˆæ–°å¢è€ƒå·æˆ–æ¨™è¨˜ç¾æœ‰è€ƒå·ç‚ºæœªå®Œæˆ</div>';
                return;
            }

            container.innerHTML = '';
            
            scheduler.schedule.forEach((day, idx) => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'schedule-day';
                dayDiv.setAttribute('data-day-index', idx);
                dayDiv.setAttribute('data-day-date', day.date);
                
                const date = new Date(day.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffDays = Math.round((date - today) / (24*3600*1000));
                
                let dayLabel = '';
                if (diffDays === 0) dayLabel = 'ä»Šå¤©';
                else if (diffDays === 1) dayLabel = 'æ˜å¤©';
                else if (diffDays < 7) dayLabel = `${diffDays} å¤©å¾Œ`;
                else dayLabel = `${Math.floor(diffDays/7)} é€±å¾Œ`;
                
                const weekday = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
                
                dayDiv.innerHTML = `
                    <div class="schedule-day-header">
                        <div class="schedule-day-title">ç¬¬ ${idx + 1} å¤© - ${dayLabel} (é€±${weekday}) ${day.date}</div>
                        <div class="schedule-day-stats">${day.totalQuestions} é¡Œ</div>
                    </div>
                    <div class="schedule-items" id="schedule-items-${idx}">
                        ${day.items.map((item, itemIdx) => `
                            <div class="schedule-item" draggable="true" data-exam-id="${item.id}" data-day-index="${idx}" data-item-index="${itemIdx}">
                                <div class="schedule-item-subject">${escapeHtml(item.subject)}</div>
                                <div class="schedule-item-chapter">
                                    ${escapeHtml(item.chapter)}
                                    ${item.partial ? '<span style="color:var(--accent-color)">ï¼ˆéƒ¨åˆ†ï¼‰</span>' : ''}
                                    ${item.dueDate ? `<span class="small" style="margin-left:8px">â° ${item.dueDate}</span>` : ''}
                                </div>
                                <div class="schedule-item-questions">${item.questions} é¡Œ</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(dayDiv);
            });

            // Setup drag and drop functionality using SortableJS
            scheduler.schedule.forEach((day, idx) => {
                const itemsContainer = document.getElementById(`schedule-items-${idx}`);
                if (itemsContainer && window.Sortable) {
                    new Sortable(itemsContainer, {
                        group: 'schedule-items',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        onEnd: function(evt) {
                            const examId = parseInt(evt.item.getAttribute('data-exam-id'));
                            const oldDayIndex = parseInt(evt.from.closest('.schedule-day').getAttribute('data-day-index'));
                            const newDayIndex = parseInt(evt.to.closest('.schedule-day').getAttribute('data-day-index'));
                            
                            if (oldDayIndex !== newDayIndex) {
                                // Item was moved to a different day
                                const newDate = scheduler.schedule[newDayIndex].date;
                                
                                // Update the exam's due date
                                const exam = exams.find(e => e.id === examId);
                                if (exam) {
                                    exam.dueDate = newDate;
                                    saveExams();
                                    render();
                                    
                                    // Regenerate schedule to reflect the change
                                    generateSchedule();
                                }
                            }
                        }
                    });
                }
            });
        }

        function showScheduler() {
            const panel = document.getElementById('scheduler-panel');
            if (panel) {
                panel.style.display = 'block';
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function hideScheduler() {
            const panel = document.getElementById('scheduler-panel');
            if (panel) panel.style.display = 'none';
        }

        function showOnboarding() {
            const modal = document.getElementById('onboarding-modal');
            if (modal) modal.style.display = 'flex';
        }

        function hideOnboarding() {
            const modal = document.getElementById('onboarding-modal');
            if (modal) modal.style.display = 'none';
        }

        function saveOnboardingSettings() {
            const dailyCapacity = parseInt(document.getElementById('daily-capacity').value) || 50;
            const priorityMode = document.getElementById('priority-mode').value;
            const bufferDays = parseInt(document.getElementById('buffer-days').value) || 2;
            
            scheduler.settings = {
                dailyCapacity,
                priorityMode,
                bufferDays,
                onboardingComplete: true
            };
            
            saveSchedulerSettings();
            hideOnboarding();
            generateSchedule();
            showScheduler();
        }

        function showScheduleSettings() {
            // Pre-fill current settings
            document.getElementById('daily-capacity').value = scheduler.settings.dailyCapacity;
            document.getElementById('priority-mode').value = scheduler.settings.priorityMode;
            document.getElementById('buffer-days').value = scheduler.settings.bufferDays;
            showOnboarding();
        }

        // Event listeners for scheduler
        const showSchedulerBtn = document.getElementById('show-scheduler');
        const regenerateScheduleBtn = document.getElementById('regenerate-schedule');
        const scheduleSettingsBtn = document.getElementById('schedule-settings');
        const hideScheduleBtn = document.getElementById('hide-schedule');
        const saveSettingsBtn = document.getElementById('save-settings');
        const skipOnboardingBtn = document.getElementById('skip-onboarding');

        if (showSchedulerBtn) {
            showSchedulerBtn.addEventListener('click', () => {
                if (!scheduler.settings.onboardingComplete) {
                    showOnboarding();
                } else {
                    if (scheduler.schedule.length === 0) {
                        generateSchedule();
                    }
                    showScheduler();
                }
            });
        }

        if (regenerateScheduleBtn) {
            regenerateScheduleBtn.addEventListener('click', () => {
                if (confirm('ç¢ºå®šè¦é‡æ–°ç”Ÿæˆæ’ç¨‹å—ï¼Ÿ')) {
                    generateSchedule();
                }
            });
        }

        if (scheduleSettingsBtn) {
            scheduleSettingsBtn.addEventListener('click', showScheduleSettings);
        }

        if (hideScheduleBtn) {
            hideScheduleBtn.addEventListener('click', hideScheduler);
        }

        if (saveSettingsBtn) {
            saveSettingsBtn.addEventListener('click', saveOnboardingSettings);
        }

        if (skipOnboardingBtn) {
            skipOnboardingBtn.addEventListener('click', () => {
                hideOnboarding();
            });
        }

        // Initialize scheduler
        loadSchedulerSettings();
        loadSchedule();

        // Auto-regenerate schedule when exams change
        const originalSaveExams = saveExams;
        saveExams = function() {
            originalSaveExams();
            // Only regenerate if scheduler has been set up
            if (scheduler.settings.onboardingComplete) {
                setTimeout(() => {
                    generateSchedule();
                }, 100);
            }
        };

        // ==================== END SMART SCHEDULER SYSTEM ====================

        // hook other UI
        G.exportAllIcs.addEventListener('click', () => downloadAllICS());
        G.exportJsonBtn.addEventListener('click', exportJSON);
        G.exportPdfBtn.addEventListener('click', exportPDF);
        G.clearDueBtn.addEventListener('click', () => {
            G.newDue.value = '';
        });

        // Add SRS and experimental planning button references
        const srsAutoPlanBtn = document.getElementById('srs-auto-plan');
        const experimentalPlanBtn = document.getElementById('experimental-plan');
        const exportSrsReportBtn = document.getElementById('export-srs-report');

        if (srsAutoPlanBtn) {
            srsAutoPlanBtn.addEventListener('click', srsAutoPlan);
        }
        if (experimentalPlanBtn) {
            experimentalPlanBtn.addEventListener('click', window.showExperimentalPlanningMenu);
        }
        if (exportSrsReportBtn) {
            exportSrsReportBtn.addEventListener('click', exportSRSReport);
        }


    });

    // Register Service Worker for PWA support
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('ServiceWorker registered: ', registration);
                    
                    // Check for updates periodically
                    setInterval(() => {
                        registration.update();
                    }, 60000); // Check every minute
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }

    // Prompt for installation (A2HS - Add to Home Screen)
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        
        // Show install button/banner (optional - can be customized)
        console.log('App can be installed');
        
        // Optionally show a custom install prompt
        const installBanner = document.createElement('div');
        installBanner.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--primary-color);color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;display:flex;gap:10px;align-items:center;';
        installBanner.innerHTML = `
            <span>å®‰è£æ‡‰ç”¨ç¨‹å¼åˆ°ä¸»ç•«é¢</span>
            <button id="install-btn" style="background:white;color:#3498db;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;font-weight:600;">å®‰è£</button>
            <button id="dismiss-install" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;">&times;</button>
        `;
        document.body.appendChild(installBanner);
        
        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                deferredPrompt = null;
                installBanner.remove();
            }
        });
        
        document.getElementById('dismiss-install').addEventListener('click', () => {
            installBanner.remove();
        });
    });

    // Track when the app was installed
    window.addEventListener('appinstalled', (evt) => {
        console.log('App was installed successfully');
    });

    // Detect if running as standalone app
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
        console.log('Running as installed PWA');
        // Add any PWA-specific behavior here
        document.body.classList.add('pwa-mode');
    }
    </script>
</body>
</html>
