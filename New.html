<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>考卷清單與訂正進度（含到期日、匯出日曆、番茄鐘）</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="一個功能完整的考卷清單管理系統，具備到期日追蹤、日曆匯出及番茄鐘計時功能" />
    <meta name="theme-color" content="#3498db" />
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="考卷清單" />
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="96x96" href="/icon-96x96.png" />
    <link rel="apple-touch-icon" sizes="128x128" href="/icon-128x128.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192x192.png" />
    <link rel="apple-touch-icon" sizes="384x384" href="/icon-384x384.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="/icon-512x512.png" />
    
    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icon-72x72.png" />
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#3498db" />
    <meta name="msapplication-TileImage" content="/icon-144x144.png" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root{
            --bg-color:#f4f7f6;
            --text-color:#333;
            --container-bg:#fff;
            --primary-color:#3498db;
            --secondary-color:#ecf0f1;
            --accent-color:#e74c3c;
            --border-color:#eee;
            --header-color:#2c3e50;
            --shadow-color:rgba(0,0,0,0.08);
            --progress-complete-color:#27ae60;
            --progress-correction-overall-color:#f39c12;
            --progress-correction-done-color:#16a085;
            --muted:#7f8c8d;
        }
        body.dark-mode{
            --bg-color:#1f2a36;
            --text-color:#ecf0f1;
            --container-bg:#263640;
            --primary-color:#5dade2;
            --secondary-color:#20303b;
            --accent-color:#e74c3c;
            --border-color:#394a56;
            --header-color:#ecf0f1;
            --shadow-color:rgba(0,0,0,0.6);
            --muted:#aab7c1;
        }
        *{box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
            background:var(--bg-color);
            color:var(--text-color);
            margin:0;
            padding:20px;
            padding-bottom: 160px;
            display:flex;
            justify-content:center;
            transition:background .25s,color .25s;
        }
        .wrap{
            width:100%;
            max-width:980px;
        }
        .container{
            background:var(--container-bg);
            padding:22px;
            border-radius:12px;
            box-shadow:0 8px 24px var(--shadow-color);
            transition:transform .18s, box-shadow .18s;
        }
        .header{
            display:flex;
            gap:12px;
            align-items:flex-start;
            justify-content:space-between;
        }
        h1{margin:0 0 6px 0; color:var(--header-color);}
        .top-actions{display:flex; gap:8px;}
        button, .icon-btn{
            padding: 6px 10px;
            font-size: 14px;
            border-radius:8px;
            border:none;
            cursor:pointer;
            background:var(--primary-color);
            color:white;
            font-weight:600;
            box-shadow:0 6px 18px rgba(0,0,0,0.06);
            transition:transform .12s, box-shadow .12s, opacity .12s;
        }
        button:active{transform:translateY(1px)}
        .icon-btn{display:inline-flex;align-items:center;gap:8px}
        .theme-toggle{
            background: #7f8c8d;
            color: white;
        }
        .toolbar{
            display:flex;flex-wrap:wrap;gap:10px;margin:16px 0 18px 0;align-items:center;
        }
        #search-box{
            padding:10px;border-radius:8px;border:1px solid var(--border-color);flex:1;min-width:160px;
            background:transparent;color:var(--text-color);
        }
        .sort-controls{display:flex;gap:8px}
        .card{
            padding:16px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
            border:1px solid var(--border-color); margin-top:14px;
        }
        .summary{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center}
        .progress-bar-container{background:#ddd;border-radius:999px;overflow:hidden;height:18px;box-shadow:inset 0 -2px 6px rgba(0,0,0,0.06)}
        .progress-bar{
            height:100%; width:0; text-align:center; line-height:18px; font-weight:700;
            color:white; transition:width .8s cubic-bezier(.2,.9,.2,1), background .4s;
            will-change:width;
        }
        .summary p{margin:6px 0 0 0;color:var(--muted);font-size:14px}
        .exam-group h3{
            background:var(--primary-color);color:white;padding:8px;border-radius:8px;margin:14px 0 8px 0;
            display:inline-block; font-size:16px;
        }
        .exam-list{list-style:none;padding:0;margin:0;display:grid;gap:8px}
        .exam-list.card-view{grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:12px}
        .exam-item{
            display:flex;align-items:center;padding:12px;border-radius:10px;border:1px solid var(--border-color);
            transition:transform .45s cubic-bezier(.2,.9,.2,1), box-shadow .22s, opacity .22s;
            background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
            will-change:transform,opacity;
            overflow:hidden;
            opacity:0; transform: translateY(10px) scale(0.995);
            animation: fadeScaleIn 420ms ease forwards;
        }
        .exam-list.card-view .exam-item{
            flex-direction:column;align-items:stretch;padding:16px;
        }
        .exam-list.card-view .exam-item .left{
            flex-direction:column;align-items:flex-start;gap:10px;
        }
        .exam-list.card-view .exam-item .exam-actions{
            margin-left:0;margin-top:12px;justify-content:flex-start;flex-wrap:wrap;
        }
        .exam-list.card-view .exam-item .correction-control{
            margin-left:0;
        }
        @keyframes fadeScaleIn{
            from{opacity:0; transform:translateY(12px) scale(0.985)}
            to{opacity:1; transform:translateY(0) scale(1)}
        }
        .exam-item .left{display:flex;align-items:center;gap:12px;flex:1}
        .exam-item input[type="checkbox"]{transform:scale(1.35);cursor:pointer}
        .exam-info{display:flex;flex-direction:column;gap:4px}
        .chapter{font-weight:700;font-size:15px;display:inline-block}
        .meta{font-size:13px;color:var(--muted)}
        .question-count{min-width:80px;text-align:right;font-weight:700;color:var(--accent-color)}
        .delete-btn{background:none;border:none;color:var(--accent-color);font-size:20px;cursor:pointer;opacity:.6}
        .delete-btn:hover{opacity:1;transform:scale(1.06)}
        .correction-control{display:flex;align-items:center;gap:6px; font-size:13px;color:var(--muted); margin-left:12px}
        .exam-item.completed .chapter{ text-decoration:line-through; opacity:0.6 }
        .due-date{font-size:13px;padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.03); color:var(--muted); margin-left:8px}
        .due-date.overdue{background:linear-gradient(90deg,#f9e0e0,#fde6e6); color:var(--accent-color); font-weight:700}
        .exam-actions{display:flex;gap:8px;align-items:center;margin-left:12px}
        
        .exam-actions .icon-btn {
            padding: 4px 8px;
            font-size: 12px;
            color: white; 
        }

        .exam-item:hover{transform:translateY(-4px) scale(1.005); box-shadow:0 10px 30px rgba(0,0,0,0.06)}
        .progress-bar.animate {
            transition: width 900ms cubic-bezier(.18,.9,.32,1), background 400ms;
        }
        .add-exam-form{margin-top:18px;padding:12px;border-radius:10px;border:1px dashed var(--border-color);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        .add-exam-form input, .add-exam-form button, .add-exam-form select{padding:8px;border-radius:8px;border:1px solid var(--border-color);background:transparent;color:var(--text-color)}
        .add-exam-form input { flex: 1 1 120px; }
        .add-exam-form input[type="number"]{ flex: 1 1 80px; }
        .add-exam-form button { flex: 1 1 80px; }
        .add-exam-form .submit{background:#27ae60;color:white;border:none}
        
        .small{font-size:13px;color:var(--muted)}
        .muted{color:var(--muted)}

        .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border-color);font-size:13px}

        /* pomodoro */
        .pomodoro-panel{
            position:fixed; right:18px; bottom:18px; width:320px; max-width:90vw; z-index:999;
            background:var(--container-bg); border-radius:14px; padding:14px; box-shadow:0 16px 48px rgba(0,0,0,0.18);
            border:1px solid var(--border-color);
            transition: opacity .4s, transform .4s cubic-bezier(.2,.9,.2,1);
        }
        .pomodoro-panel:not(.hidden) {
            animation: popIn 420ms cubic-bezier(.2,.9,.2,1) forwards;
        }
        .pomodoro-panel.hidden {
            opacity: 0;
            transform: translateY(24px) scale(.98);
            pointer-events: none;
            visibility: hidden;
        }
        @keyframes popIn{
            from{opacity:0; transform: translateY(24px) scale(.98)}
            to{opacity:1; transform: translateY(0) scale(1)}
        }
        .pomodoro-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
        .timer-display{font-size:36px;font-weight:800;text-align:center;margin:8px 0; transition:transform .15s}
        .pom-controls{display:flex;gap:8px;justify-content:center}
        .cycle-indicator{display:flex;gap:6px;justify-content:center;margin-top:8px}
        .cycle-dot{width:10px;height:10px;border-radius:50%;background:#ddd}
        .cycle-dot.active{background:var(--primary-color); box-shadow:0 6px 14px rgba(0,0,0,0.08)}
        .pom-close-btn {
            background: none; border: none; font-size: 22px;
            color: var(--muted); cursor: pointer; padding: 0 4px; line-height: 1;
        }
        .pom-close-btn:hover { color: var(--text-color); }

        .pom-fullscreen {
            position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center;
            background: rgba(0,0,0,0.7); transition:opacity .18s;
        }
        .pom-fullscreen .pom-inner {
            width: min(920px, 96vw); background: var(--container-bg); padding: 28px; border-radius:12px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.6); text-align:center;
        }
        .pom-fullscreen .timer-display { font-size:96px; }
        .pom-fullscreen .pom-controls button { font-size:20px; padding:10px 18px; border-radius:12px; }

        @media (max-width:720px){
            body { 
                padding: 10px; 
                padding-bottom: 160px;
            }
            .container { padding: 15px; }
            .summary{grid-template-columns:1fr}
            .top-actions{flex-wrap:wrap}
            .toolbar { flex-direction: column; align-items: stretch; }
            .pomodoro-panel{right:8px;left:8px;bottom:12px;width:auto}
        }
        
        /* PWA Mode adjustments */
        body.pwa-mode {
            /* Add extra padding for iOS safe areas */
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 160px);
        }
        
        @supports (padding: max(0px)) {
            body.pwa-mode {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
            }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="container">
            <div class="header">
                <div>
                    <h1>考卷清單</h1>
                    <div class="small muted">到期日、匯出日曆 (.ics)、番茄鐘 — 已保留你的預設清單</div>
                </div>
                <div class="top-actions">
                    <button id="show-pomodoro" class="icon-btn">顯示番茄鐘</button>
                    <button id="pom-fullscreen-toggle" class="icon-btn">番茄鐘全螢幕</button>
                    <button id="export-all-ics" class="icon-btn">匯出全部到日曆</button>
                    <button id="export-json" class="icon-btn">匯出 JSON</button>
                    <button id="export-pdf" class="icon-btn">匯出 PDF</button>
                    <label for="import-json-file" class="icon-btn" style="cursor:pointer;padding:6px 10px">匯入 JSON</label>
                    <input type="file" id="import-json-file" accept="application/json" style="display:none" />
                    <button id="clear-storage" class="theme-toggle">清除本機資料</button>
                    <button id="theme-toggle" class="theme-toggle">切換深色</button>
                </div>
            </div>

            <div class="toolbar">
                <input id="search-box" placeholder="搜尋科目或章節..." />
                <div class="sort-controls">
                    <button id="sort-by-questions">按題數排序</button>
                    <button id="sort-by-chapter">按章節排序</button>
                    <button id="sort-by-due">依到期日排序</button>
                    <button id="toggle-card-view" class="theme-toggle">切換卡片檢視</button>
                </div>
                <div style="display:flex;gap:6px;align-items:center;margin-left:12px">
                    <select id="filter-select" class="small" title="篩選">
                        <option value="all">全部</option>
                        <option value="today">當日到期</option>
                        <option value="overdue">已過期</option>
                        <option value="7days">七天內</option>
                        <option value="noduedate">無標示到期日</option>
                    </select>
                    <div class="pill small">總題數：<span id="total-questions">0</span></div>
                </div>
            </div>

            <div class="card summary">
                <div>
                    <h4>完成進度</h4>
                    <div class="progress-bar-container" style="margin-top:8px">
                        <div id="progress-bar" class="progress-bar" style="background:var(--progress-complete-color)">0%</div>
                    </div>
                    <p>尚未完成總題數: <strong id="remaining-questions">0</strong> | 已完成總題數: <strong id="completed-questions">0</strong></p>
                </div>
                <div>
                    <h4>訂正進度</h4>
                    <div style="margin-top:8px">
                        <div class="small muted">整體（含未完成）</div>
                        <div class="progress-bar-container" style="margin-top:6px">
                            <div id="correction-progress-bar" class="progress-bar" style="background:var(--progress-correction-overall-color)">0%</div>
                        </div>
                        <div class="small muted" style="margin-top:8px">已完成考卷之訂正進度</div>
                        <div class="progress-bar-container" style="margin-top:6px">
                            <div id="completed-correction-progress-bar" class="progress-bar" style="background:var(--progress-correction-done-color)">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="exam-list-container"></div>

            <div class="add-exam-form">
                <input type="text" id="new-subject" placeholder="科目" required />
                <input type="text" id="new-chapter" placeholder="章節" required />
                <input type="number" id="new-questions" placeholder="題數" required min="1" />
                <input type="date" id="new-due" />
                <button id="clear-due-btn" class="icon-btn small" style="background:#95a5a6">清除日期</button>
                <button id="add-btn" class="submit">新增</button>
                <div style="margin-left:auto" class="small muted">到期日(選填)，匯出日曆時會使用</div>
            </div>
        </div>
    </div>

    <!-- fullscreen container (created/hidden dynamically) -->
    <div id="pom-fullscreen" style="display:none"></div>

    <div class="pomodoro-panel" id="pomodoro-panel" aria-live="polite">
        <div class="pomodoro-header">
            <div style="display:flex;gap:8px;align-items:center">
                <strong>番茄鐘</strong>
                <span id="pom-selected" class="small muted">（尚未選擇考卷）</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
                <select id="pom-mode" class="small">
                    <option value="pom">工作（番茄）</option>
                    <option value="short">短休</option>
                    <option value="long">長休</option>
                </select>
                <button id="pom-close" class="pom-close-btn" title="隱藏">&times;</button>
                <button id="pom-start">開始</button>
            </div>
        </div>
        <div class="timer-display" id="timer-display">25:00</div>
        <div class="pom-controls">
            <button id="pom-pause" class="theme-toggle">暫停</button>
            <button id="pom-reset" class="theme-toggle">重設</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:center">
            <div class="small muted">週期</div>
            <div id="pom-cycle" class="cycle-indicator"></div>
        </div>
        <div style="margin-top:10px;display:flex;justify-content:center;gap:8px;align-items:center">
            <label class="small muted" style="display:flex;align-items:center;gap:6px">
                <input type="checkbox" id="pom-enable-sound" /> 啟用音效
            </label>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        

        let exams = [];
        let sortState = { key: 'chapter', direction: 'asc' };
        let cardViewMode = false;


        const G = {
            container: document.getElementById('exam-list-container'),
            remainingEl: document.getElementById('remaining-questions'),
            completedEl: document.getElementById('completed-questions'),
            progressBar: document.getElementById('progress-bar'),
            correctionProgressBar: document.getElementById('correction-progress-bar'),
            completedCorrectionProgressBar: document.getElementById('completed-correction-progress-bar'),
            searchBox: document.getElementById('search-box'),
            addBtn: document.getElementById('add-btn'),
            newSubject: document.getElementById('new-subject'),
            newChapter: document.getElementById('new-chapter'),
            newQuestions: document.getElementById('new-questions'),
            newDue: document.getElementById('new-due'),
            sortByQuestionsBtn: document.getElementById('sort-by-questions'),
            sortByChapterBtn: document.getElementById('sort-by-chapter'),
            sortByDueBtn: document.getElementById('sort-by-due'),
            toggleCardViewBtn: document.getElementById('toggle-card-view'),
            exportAllIcs: document.getElementById('export-all-ics'),
            exportJsonBtn: document.getElementById('export-json'),
            exportPdfBtn: document.getElementById('export-pdf'),
            importJsonFile: document.getElementById('import-json-file'),
            totalQuestionsEl: document.getElementById('total-questions'),
            themeToggle: document.getElementById('theme-toggle'),
            clearStorageBtn: document.getElementById('clear-storage'),
            clearDueBtn: document.getElementById('clear-due-btn'),
            showPomodoroBtn: document.getElementById('show-pomodoro'),
            pomFullscreenToggle: document.getElementById('pom-fullscreen-toggle'),
            filterSelect: document.getElementById('filter-select'),
            pom: {
                panel: document.getElementById('pomodoro-panel'),
                display: document.getElementById('timer-display'),
                start: document.getElementById('pom-start'),
                pause: document.getElementById('pom-pause'),
                reset: document.getElementById('pom-reset'),
                mode: document.getElementById('pom-mode'),
                selected: document.getElementById('pom-selected'),
                cycle: document.getElementById('pom-cycle'),
                close: document.getElementById('pom-close'),
                enableSound: document.getElementById('pom-enable-sound')
            }
        };

        function saveExams(){ localStorage.setItem('examsList', JSON.stringify(exams)); }
        function loadExams(){
            const s = localStorage.getItem('examsList');
            if(s){
                exams = JSON.parse(s).map(e => ({ corrected:false, dueDate:null, ...e }));
            } else {
                exams = initialData.slice();
            }
        }

        function render(){
            G.container.innerHTML = '';
            const q = G.searchBox.value.trim().toLowerCase();
            const filter = G.filterSelect.value;
            const filtered = exams.filter(exam => {
                const matchesText = exam.subject.toLowerCase().includes(q) || exam.chapter.toLowerCase().includes(q);
                if(!matchesText) return false;

                // filter logic
                const now = new Date();
                const nowMid = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                if(filter === 'all') return true;
                if(filter === 'noduedate') return !exam.dueDate;
                if(!exam.dueDate) return false;
                const due = new Date(exam.dueDate);
                const dueMid = new Date(due.getFullYear(), due.getMonth(), due.getDate());
                const diffDays = Math.round((dueMid - nowMid) / (24*3600*1000));
                if(filter === 'today') return diffDays === 0;
                if(filter === 'overdue') return diffDays < 0;
                if(filter === '7days') return diffDays >= 0 && diffDays <= 7;
                return true;
            });

            const grouped = filtered.reduce((acc, exam) => {
                (acc[exam.subject] = acc[exam.subject] || []).push(exam);
                return acc;
            }, {});
            const subjectKeys = Object.keys(grouped).sort();
            subjectKeys.forEach(subject => {
                const list = grouped[subject];
                list.sort((a,b) => {
                    let va = a[sortState.key], vb = b[sortState.key];
                    if(sortState.key === 'dueDate'){
                        if(!va && !vb) return 0;
                        if(!va) return sortState.direction === 'asc' ? 1 : -1;
                        if(!vb) return sortState.direction === 'asc' ? -1 : 1;
                        va = new Date(va).getTime();
                        vb = new Date(vb).getTime();
                    }
                    if(typeof va === 'string') va = va.toLowerCase();
                    if(typeof vb === 'string') vb = vb.toLowerCase();
                    if(va > vb) return sortState.direction === 'asc' ? 1 : -1;
                    if(va < vb) return sortState.direction === 'asc' ? -1 : 1;
                    return 0;
                });
            });

            subjectKeys.forEach(subject => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'exam-group';
                groupDiv.innerHTML = `<h3>${subject}</h3>`;
                const ul = document.createElement('ul');
                ul.className = 'exam-list';
                if(cardViewMode) ul.classList.add('card-view');
                grouped[subject].forEach(exam => {
                    const li = document.createElement('li');
                    li.className = 'exam-item';
                    if(exam.completed) li.classList.add('completed');
                    let dueHtml = '';
                    if(exam.dueDate){
                        const now = new Date();
                        const due = new Date(exam.dueDate);
                        const nowMid = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const dueMid = new Date(due.getFullYear(), due.getMonth(), due.getDate());
                        const diffDays = Math.round((dueMid - nowMid) / (24*3600*1000));
                        const overdue = diffDays < 0;
                        const label = overdue ? `已過期 ${Math.abs(diffDays)} 天` : (diffDays === 0 ? '到期：今天' : `到期：${diffDays} 天後`);
                        dueHtml = `<span class="due-date ${overdue ? 'overdue': ''}" title="${formatDate(due)}">${label}</span>`;
                    }
                    li.innerHTML = `
                        <div class="left">
                            <input type="checkbox" class="completion-checkbox" data-id="${exam.id}" ${exam.completed ? 'checked' : ''} />
                            <div class="exam-info">
                                <div>
                                    <span class="chapter">${escapeHtml(exam.chapter)}</span>
                                    ${dueHtml}
                                </div>
                                <div class="meta small muted">${escapeHtml(exam.subject)} ・ <span class="meta-questions">${exam.questions} 題</span></div>
                            </div>
                        </div>
                        <div class="exam-actions">
                            <label class="correction-control"><input type="checkbox" class="correction-checkbox" data-id="${exam.id}" ${exam.corrected ? 'checked' : ''} /> 訂正</label>
                            <button class="icon-btn edit-btn small" data-id="${exam.id}">編輯</button>
                            <button class="icon-btn ics-btn small" data-id="${exam.id}">匯出日曆</button>
                            <button class="delete-btn" data-id="${exam.id}" title="刪除">&times;</button>
                        </div>
                    `;
                    ul.appendChild(li);
                });
                groupDiv.appendChild(ul);
                G.container.appendChild(groupDiv);
            });
            updateSummary();
            attachRowListeners();
        }

        function attachRowListeners(){
            document.querySelectorAll('.completion-checkbox').forEach(cb => cb.addEventListener('change', e => toggleExam(Number(cb.dataset.id))));
            document.querySelectorAll('.correction-checkbox').forEach(cb => cb.addEventListener('change', e => toggleCorrection(Number(cb.dataset.id))));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => deleteExam(Number(btn.dataset.id))));
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => openEditDialog(Number(btn.dataset.id))));
            document.querySelectorAll('.ics-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const exam = exams.find(x => x.id === Number(btn.dataset.id));
                    if(exam) downloadICS(exam);
                });
            });
            document.querySelectorAll('.chapter').forEach(el => {
                el.style.cursor = 'pointer';
                el.addEventListener('click', e => {
                    const li = el.closest('.exam-item');
                    selectPomodoroExam(findIdFromElement(li));
                });
            });
        }

        function findIdFromElement(el){
            const checkbox = el.querySelector('.completion-checkbox');
            return checkbox ? Number(checkbox.dataset.id) : null;
        }

        function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
        function formatDate(d){
            if(!d) return '';
            const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${day}`;
        }

        function updateSummary(){
            let remainingTotal = 0, completedTotal = 0, totalQuestions = 0, correctedTotal = 0;
            exams.forEach(exam => {
                totalQuestions += Number(exam.questions || 0);
                if(exam.completed){
                    completedTotal += Number(exam.questions || 0);
                    if(exam.corrected) correctedTotal += Number(exam.questions || 0);
                } else {
                    remainingTotal += Number(exam.questions || 0);
                }
            });
            G.remainingEl.textContent = remainingTotal;
            G.completedEl.textContent = completedTotal;
            G.totalQuestionsEl.textContent = totalQuestions;
            animateBar(G.progressBar, totalQuestions > 0 ? Math.round((completedTotal/totalQuestions)*100) : 0);
            animateBar(G.correctionProgressBar, totalQuestions > 0 ? Math.round((correctedTotal/totalQuestions)*100) : 0);
            animateBar(G.completedCorrectionProgressBar, completedTotal > 0 ? Math.round((correctedTotal/completedTotal)*100) : 0);
        }

        function animateBar(el, pct){
            el.classList.add('animate');
            el.style.width = pct + '%';
            el.textContent = pct + '%';
            setTimeout(()=> el.classList.remove('animate'), 900);
        }

        function toggleExam(id){
            const ex = exams.find(e => e.id === id);
            if(!ex) return;
            ex.completed = !ex.completed;
            if(!ex.completed) ex.corrected = false;
            saveExams(); render();
        }
        function toggleCorrection(id){
            const ex = exams.find(e => e.id === id);
            if(!ex || !ex.completed) return;
            ex.corrected = !ex.corrected;
            saveExams(); render();
        }
        function deleteExam(id){
            const el = document.querySelector(`[data-id="${id}"]`)?.closest('.exam-item');
            exams = exams.filter(e => e.id !== id);
            saveExams();
            if(el){
                el.style.opacity = '0'; el.style.transform = 'scale(.98) translateX(-8px)';
                setTimeout(render, 220);
            } else render();
        }

        function addExam(e){
            e && e.preventDefault && e.preventDefault();
            const subject = G.newSubject.value.trim();
            const chapter = G.newChapter.value.trim();
            const questions = Number(G.newQuestions.value || 0);
            const dueVal = G.newDue.value || null;
            if(!subject || !chapter || questions <= 0) return alert('請填科目、章節與題數（題數需大於 0）');
            exams.push({
                id: Date.now()+Math.floor(Math.random()*999),
                subject, chapter, questions, completed:false, corrected:false, dueDate: dueVal ? dueVal : null
            });
            saveExams();
            render();
            G.newSubject.value=''; G.newChapter.value=''; G.newQuestions.value=''; G.newDue.value='';
        }

        function openEditDialog(id){
            const ex = exams.find(x => x.id === id);
            if(!ex) return;
            const subject = prompt('編輯科目：', ex.subject); if(subject === null) return;
            const chapter = prompt('編輯章節：', ex.chapter); if(chapter === null) return;
            const questions = prompt('編輯題數：', ex.questions); if(questions === null) return;
            const due = prompt('到期日 (YYYY-MM-DD, 空白表示清除)：', ex.dueDate || '');
            const qn = Number(questions);
            if(isNaN(qn) || qn <= 0){ alert('題數不合法'); return; }
            ex.subject = subject.trim() || ex.subject;
            ex.chapter = chapter.trim() || ex.chapter;
            ex.questions = qn;
            ex.dueDate = due ? due.trim() : null;
            saveExams(); render();
        }

        function pad(n){ return String(n).padStart(2,'0'); }
        
        function downloadFile(filename, content, mime='text/calendar;charset=utf-8'){
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            a.remove(); URL.revokeObjectURL(url);
        }

        // ICS creation: improved for compatibility (DTSTAMP, UID, METHOD:PUBLISH)
        function toUTCStamp(date){
            const y = date.getUTCFullYear(), m = pad(date.getUTCMonth()+1), d = pad(date.getUTCDate()),
                hh = pad(date.getUTCHours()), mm = pad(date.getUTCMinutes()), ss = pad(date.getUTCSeconds());
            return `${y}${m}${d}T${hh}${mm}${ss}Z`;
        }

        function escapeICSText(s){ return (s||'').replace(/\\/g, '\\\\').replace(/,/g,'\\,').replace(/;/g, '\\;').replace(/\n/g, '\\n'); }

        function createICSForExam(exam) {
            const e = {...exam};
            if (!e.dueDate) {
                // If no due date, default to today's date (local)
                const today = new Date();
                e.dueDate = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;
            }

            // DTSTART and DTEND as all-day dates (VALUE=DATE). Ensure DTEND is next day.
            const dateParts = e.dueDate.split('-').map(part => parseInt(part, 10));
            const startDateObj = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2]));
            const endDateObj = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2]));
            endDateObj.setUTCDate(endDateObj.getUTCDate() + 1);

            const dtStart = `${startDateObj.getUTCFullYear()}${pad(startDateObj.getUTCMonth()+1)}${pad(startDateObj.getUTCDate())}`;
            const dtEnd = `${endDateObj.getUTCFullYear()}${pad(endDateObj.getUTCMonth()+1)}${pad(endDateObj.getUTCDate())}`;

            const summary = `到期：${e.subject} ${e.chapter} (${e.questions} 題)`;
            const description = `考卷到期：${e.subject} ${e.chapter}\\n題數：${e.questions}\\n來源：考卷清單`;

            const uid = `exam-${e.id}-${Date.now()}@examlist.local`;
            const dtstamp = toUTCStamp(new Date());

            const icsEvent = [
                'BEGIN:VEVENT',
                `UID:${uid}`,
                `DTSTAMP:${dtstamp}`,
                `SUMMARY:${escapeICSText(summary)}`,
                `DESCRIPTION:${escapeICSText(description)}`,
                `DTSTART;VALUE=DATE:${dtStart}`,
                `DTEND;VALUE=DATE:${dtEnd}`,
                `CATEGORIES:${escapeICSText(e.subject)}`,
                'TRANSP:TRANSPARENT',
                'SEQUENCE:0',
                'END:VEVENT'
            ].join('\r\n');

            return icsEvent;
        }

        function downloadICS(exam){
            const icsEvent = createICSForExam(exam);
            const icsCalendar = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//ExamList//SingleExport//TW',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                icsEvent,
                'END:VCALENDAR'
            ].join('\r\n');
            downloadFile(`${(exam.subject+'-'+(exam.chapter || 'exam')).replace(/\s+/g,'_')}.ics`, icsCalendar);
        }

        function downloadAllICS(){
            const events = exams.map(ex => createICSForExam(ex)).join('\r\n');
            const ics = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//ExamList//CalendarExportAll//TW',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:考卷清單',
                events,
                'END:VCALENDAR'
            ].join('\r\n');
            downloadFile('exams_all.ics', ics);
        }

        // JSON export/import
        function exportJSON(){
            const data = JSON.stringify(exams, null, 2);
            downloadFile('exams.json', data, 'application/json;charset=utf-8');
        }

        // PDF export with Traditional Chinese support
        async function exportPDF(){
            // Check if jsPDF is available
            if (!window.jspdf && !window.jsPDF) {
                alert('PDF 匯出功能載入中，請稍後再試');
                return;
            }
            const { jsPDF } = window.jspdf || window;
            
            // Create a temporary container for rendering
            const container = document.createElement('div');
            container.style.cssText = 'position:absolute;left:-9999px;top:0;width:800px;background:white;padding:30px;font-family:Arial,sans-serif;';
            document.body.appendChild(container);
            
            // Summary statistics
            let remainingTotal = 0, completedTotal = 0, totalQuestions = 0, correctedTotal = 0;
            exams.forEach(exam => {
                totalQuestions += Number(exam.questions || 0);
                if(exam.completed){
                    completedTotal += Number(exam.questions || 0);
                    if(exam.corrected) correctedTotal += Number(exam.questions || 0);
                } else {
                    remainingTotal += Number(exam.questions || 0);
                }
            });
            
            // Build HTML content with Chinese characters
            let html = `
                <div style="text-align:center;font-size:24px;font-weight:bold;margin-bottom:20px;color:#2c3e50;">
                    考卷清單
                </div>
                <div style="font-size:14px;margin-bottom:25px;line-height:1.8;color:#333;">
                    <div>總題數: ${totalQuestions}</div>
                    <div>尚未完成: ${remainingTotal} | 已完成: ${completedTotal}</div>
                    <div>已訂正: ${correctedTotal}</div>
                </div>
            `;
            
            // Add exam cards
            exams.forEach((exam, idx) => {
                const bgColor = exam.completed ? '#e6fae6' : '#fafafa';
                const status = exam.completed ? (exam.corrected ? "已完成+已訂正" : "已完成") : "未完成";
                const dueText = exam.dueDate ? exam.dueDate : "未設定";
                
                html += `
                    <div style="border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:12px;background:${bgColor};">
                        <div style="font-size:16px;font-weight:bold;margin-bottom:8px;color:#2c3e50;">${exam.subject}</div>
                        <div style="font-size:12px;line-height:1.6;color:#555;">
                            <div>章節: ${exam.chapter}</div>
                            <div>題數: ${exam.questions}</div>
                            <div style="font-weight:bold;">狀態: ${status}</div>
                            <div>到期日: ${dueText}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Render to canvas with html2canvas (supports Chinese fonts)
            try {
                const canvas = await html2canvas(container, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false
                });
                
                // Create PDF and add the rendered image
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // If content is too tall, split into multiple pages
                const pageHeight = 295; // A4 height in mm
                let heightLeft = imgHeight;
                let position = 0;
                
                doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                doc.save('exams.pdf');
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('PDF 匯出失敗，請稍後再試');
            } finally {
                // Clean up
                document.body.removeChild(container);
            }
        }

        function importJSON(file){
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e){
                try{
                    const parsed = JSON.parse(e.target.result);
                    if(!Array.isArray(parsed)) throw new Error('JSON 格式錯誤（需為陣列）');
                    // Basic validation and normalize
                    const normalized = parsed.map(item => ({
                        id: item.id || (Date.now()+Math.floor(Math.random()*999)),
                        subject: item.subject || '未命名',
                        chapter: item.chapter || '',
                        questions: Number(item.questions) || 0,
                        completed: !!item.completed,
                        corrected: !!item.corrected,
                        dueDate: item.dueDate || null
                    }));
                    if(confirm('匯入將覆蓋現有清單，確定嗎？')) {
                        exams = normalized;
                        saveExams(); render();
                        alert('匯入完成');
                    }
                } catch(err){
                    alert('讀取 JSON 發生錯誤：' + err.message);
                }
            };
            reader.readAsText(file);
        }

        G.sortByQuestionsBtn.addEventListener('click', () => { sortState.key = 'questions'; sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; render(); });
        G.sortByChapterBtn.addEventListener('click', () => { sortState.key = 'chapter'; sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; render(); });
        G.sortByDueBtn.addEventListener('click', () => { sortState.key = 'dueDate'; sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; render(); });
        G.toggleCardViewBtn.addEventListener('click', () => { cardViewMode = !cardViewMode; localStorage.setItem('cardViewMode', cardViewMode); render(); });
        G.searchBox.addEventListener('input', debounce(() => render(), 180));
        G.addBtn.addEventListener('click', addExam);
        G.exportAllIcs.addEventListener('click', () => downloadAllICS());
        G.exportJsonBtn.addEventListener('click', exportJSON);
        G.importJsonFile.addEventListener('change', (ev) => {
            const f = ev.target.files && ev.target.files[0];
            if(f) importJSON(f);
            ev.target.value = '';
        });
        G.themeToggle.addEventListener('click', () => {
            const current = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            applyTheme(current === 'light' ? 'dark' : 'light');
        });
        function applyTheme(t){
            if(t === 'dark') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', t);
        }
        G.clearStorageBtn.addEventListener('click', () => {
            if(confirm('確定要清除本機儲存的考卷資料並回復預設清單？')) {
                localStorage.removeItem('examsList');
                loadExams(); render();
            }
        });
        G.filterSelect.addEventListener('change', () => render());
        function debounce(fn, wait){ let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn(...a), wait); }; }

        // Pomodoro
        const pom = {
            durations: { pom:25*60, short:5*60, long:15*60 },
            timerId: null, remaining: 25*60, running: false, selectedExamId: null, cycles: 0,
        };

        // WebAudio setup for beep
        let audioCtx = null;
        function ensureAudioContext(){
            if(audioCtx) return audioCtx;
            try{
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }catch(e){
                audioCtx = null;
            }
            return audioCtx;
        }
        function playBeep(){
            if(!G.pom.enableSound.checked) return;
            const ctx = ensureAudioContext();
            if(!ctx) return;
            if (ctx.state === 'suspended') {
                // some browsers require resume by user gesture; try to resume
                ctx.resume().catch(()=>{});
            }
            // Continuous beeps - play 5 beeps with pauses
            const now = ctx.currentTime;
            for(let i = 0; i < 5; i++){
                const beepStart = now + (i * 0.5);
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.type = 'sine';
                o.frequency.value = 880;
                o.connect(g);
                g.connect(ctx.destination);
                g.gain.setValueAtTime(0.001, beepStart);
                g.gain.exponentialRampToValueAtTime(0.18, beepStart + 0.02);
                o.start(beepStart);
                g.gain.exponentialRampToValueAtTime(0.0001, beepStart + 0.35);
                o.stop(beepStart + 0.36);
            }
        }

        function selectPomodoroExam(id){
            const exam = exams.find(e => e.id === id);
            if(!exam){ G.pom.selected.textContent = '（尚未選擇考卷）'; return; }
            pom.selectedExamId = id;
            G.pom.selected.textContent = `｜ ${exam.subject} ${exam.chapter}`;
            const mode = G.pom.mode.value;
            pom.remaining = pom.durations[mode];
            updateTimerDisplay(); renderCycleDots();
        }
        function updateTimerDisplay(){
            const mm = Math.floor(pom.remaining/60), ss = pom.remaining % 60;
            G.pom.display.textContent = `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
            if(pom.remaining <= 10 && pom.running){
                G.pom.display.style.transform = 'scale(1.02)';
                setTimeout(()=> G.pom.display.style.transform = '', 220);
            }
        }
        function startPomodoro(){
            if(pom.timerId) return;
            pom.running = true;
            const mode = G.pom.mode.value;
            if(pom.remaining <= 0) pom.remaining = pom.durations[mode];
            pom.timerId = setInterval(() => {
                pom.remaining -= 1;
                if(pom.remaining <= 0){
                    clearInterval(pom.timerId); pom.timerId = null; pom.running = false;
                    if(mode === 'pom') pom.cycles++;
                    notifyUser('番茄鐘結束', `模式 ${mode} 已完成。`);
                    playBeep();
                }
                updateTimerDisplay(); renderCycleDots();
            }, 1000);
            updateTimerDisplay();
        }
        function pausePomodoro(){
            if(pom.timerId){ clearInterval(pom.timerId); pom.timerId = null; pom.running = false; }
            else { startPomodoro(); }
        }
        function resetPomodoro(){
            const mode = G.pom.mode.value;
            if(pom.timerId){ clearInterval(pom.timerId); pom.timerId = null; }
            pom.running = false;
            pom.remaining = pom.durations[mode];
            updateTimerDisplay();
        }
        G.pom.start.addEventListener('click', () => { startPomodoro(); });
        G.pom.pause.addEventListener('click', pausePomodoro);
        G.pom.reset.addEventListener('click', resetPomodoro);
        G.pom.mode.addEventListener('change', () => {
            pom.remaining = pom.durations[G.pom.mode.value]; updateTimerDisplay();
        });
        function renderCycleDots(){
            const container = G.pom.cycle; container.innerHTML = '';
            for(let i=0;i<4;i++){
                const dot = document.createElement('div');
                dot.className = 'cycle-dot' + (i < pom.cycles ? ' active' : '');
                container.appendChild(dot);
            }
        }
        function notifyUser(title, body){
            try {
                if(Notification.permission === 'granted') new Notification(title, { body });
                else if(Notification.permission !== 'denied') Notification.requestPermission().then(p => { if(p === 'granted') new Notification(title,{body}); });
            } catch(e){}
            G.pom.display.style.transition = 'box-shadow .2s';
            G.pom.display.style.boxShadow = '0 8px 28px rgba(0,0,0,0.18)';
            setTimeout(()=> G.pom.display.style.boxShadow = '', 1200);
        }

        G.pom.close.addEventListener('click', () => {
            G.pom.panel.classList.add('hidden');
            localStorage.setItem('pomodoroHidden', 'true');
        });
        G.showPomodoroBtn.addEventListener('click', () => {
            G.pom.panel.classList.remove('hidden');
            localStorage.setItem('pomodoroHidden', 'false');
        });
        function initPomodoroVisibility() {
            if (localStorage.getItem('pomodoroHidden') === 'true') {
                G.pom.panel.classList.add('hidden');
            }
        }

        // Fullscreen display for pomodoro (custom fullscreen overlay)
        const pomFsContainer = document.getElementById('pom-fullscreen');
        G.pomFullscreenToggle.addEventListener('click', () => togglePomFullscreen());

        function togglePomFullscreen(){
            if(pomFsContainer.style.display === 'none' || pomFsContainer.style.display === ''){
                // open
                pomFsContainer.style.display = 'block';
                pomFsContainer.innerHTML = `
                <div class="pom-fullscreen" id="pomfs-outer">
                    <div class="pom-inner">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <strong style="font-size:22px">番茄鐘（全螢幕）</strong>
                            <div>
                                <button id="pomfs-close" style="margin-right:8px" class="theme-toggle">關閉</button>
                                <button id="pomfs-start" class="icon-btn">開始</button>
                            </div>
                        </div>
                        <div style="margin-top:20px">
                            <div id="pomfs-display" class="timer-display">25:00</div>
                            <div style="margin-top:12px">
                                <button id="pomfs-pause" class="theme-toggle">暫停/繼續</button>
                                <button id="pomfs-reset" class="theme-toggle">重設</button>
                            </div>
                            <div style="margin-top:12px">
                                <label class="small muted" style="display:flex;align-items:center;gap:8px;justify-content:center">
                                    <input type="checkbox" id="pomfs-enable-sound" /> 啟用音效
                                </label>
                            </div>
                        </div>
                    </div>
                </div>`;
                // hook buttons
                document.getElementById('pomfs-close').addEventListener('click', () => {
                    pomFsContainer.style.display = 'none';
                    pomFsContainer.innerHTML = '';
                });
                document.getElementById('pomfs-start').addEventListener('click', () => {
                    // sync sound checkbox
                    const fsSound = document.getElementById('pomfs-enable-sound');
                    fsSound.checked = G.pom.enableSound.checked;
                    startPomodoro();
                });
                document.getElementById('pomfs-pause').addEventListener('click', () => {
                    pausePomodoro();
                });
                document.getElementById('pomfs-reset').addEventListener('click', () => {
                    resetPomodoro();
                });
                // reflect display
                const fsDisplay = document.getElementById('pomfs-display');
                const fsInterval = setInterval(()=> {
                    fsDisplay.textContent = G.pom.display.textContent;
                    // sync the fs sound checkbox to main
                    const fsSound = document.getElementById('pomfs-enable-sound');
                    if(fsSound) fsSound.addEventListener('change', (e)=> { G.pom.enableSound.checked = e.target.checked; });
                    if(pomFsContainer.style.display === 'none') clearInterval(fsInterval);
                }, 300);
            } else {
                pomFsContainer.style.display = 'none';
                pomFsContainer.innerHTML = '';
            }
        }

        // initial load
        loadExams();
        cardViewMode = localStorage.getItem('cardViewMode') === 'true';
        applyTheme(localStorage.getItem('theme') || 'light');
        initPomodoroVisibility();
        render();
        renderCycleDots();
        setTimeout(()=> updateSummary(), 120);
        document.addEventListener('keydown', (e) => {
            if(e.code === 'Space' && document.activeElement.tagName !== 'INPUT'){
                e.preventDefault(); pausePomodoro();
            }
        });
        window.EXAM_APP = { exams, saveExams, loadExams, render, downloadAllICS, downloadICS };

        // hook other UI
        G.exportAllIcs.addEventListener('click', () => downloadAllICS());
        G.exportJsonBtn.addEventListener('click', exportJSON);
        G.exportPdfBtn.addEventListener('click', exportPDF);
        G.clearDueBtn.addEventListener('click', () => {
            G.newDue.value = '';
        });

    });

    // Register Service Worker for PWA support
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('ServiceWorker registered: ', registration);
                    
                    // Check for updates periodically
                    setInterval(() => {
                        registration.update();
                    }, 60000); // Check every minute
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }

    // Prompt for installation (A2HS - Add to Home Screen)
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        
        // Show install button/banner (optional - can be customized)
        console.log('App can be installed');
        
        // Optionally show a custom install prompt
        const installBanner = document.createElement('div');
        installBanner.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--primary-color);color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;display:flex;gap:10px;align-items:center;';
        installBanner.innerHTML = `
            <span>安裝應用程式到主畫面</span>
            <button id="install-btn" style="background:white;color:#3498db;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;font-weight:600;">安裝</button>
            <button id="dismiss-install" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;">&times;</button>
        `;
        document.body.appendChild(installBanner);
        
        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                deferredPrompt = null;
                installBanner.remove();
            }
        });
        
        document.getElementById('dismiss-install').addEventListener('click', () => {
            installBanner.remove();
        });
    });

    // Track when the app was installed
    window.addEventListener('appinstalled', (evt) => {
        console.log('App was installed successfully');
    });

    // Detect if running as standalone app
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
        console.log('Running as installed PWA');
        // Add any PWA-specific behavior here
        document.body.classList.add('pwa-mode');
    }
    </script>
</body>
</html>
